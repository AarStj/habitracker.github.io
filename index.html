<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Habit Tracker v7.2 Fixed</title>
    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-body: #ffffff;
            --bg-surface: #f9fafb;
            --bg-surface-hover: #f3f4f6;
            --text-main: #111827;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --primary: #000000;
            --on-primary: #ffffff;
            --danger: #ef4444;
            --success: #22c55e;
            --toast-bg: #111111;
            --toast-text: #ffffff;
            --scrollbar-thumb: #9ca3af;
            --scrollbar-bg: #e5e7eb;
            --menu-bg: #ffffff;
        }

        html.dark {
            --bg-body: #050505;
            --bg-surface: #111111;
            --bg-surface-hover: #1f1f1f;
            --text-main: #e0e0e0;
            --text-muted: #6b7280;
            --border-color: #222222;
            --primary: #ffffff;
            --on-primary: #000000;
            --danger: #ef4444;
            --success: #22c55e;
            --toast-bg: #ffffff;
            --toast-text: #000000;
            --scrollbar-thumb: #333333;
            --scrollbar-bg: #000000;
            --menu-bg: #0a0a0a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            position: fixed; inset: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
            zoom: 0.85; 
        }

        button { background: none; border: none; cursor: pointer; color: inherit; font-family: inherit; outline: none; }
        input, textarea { font-family: inherit; color: inherit; }
        
        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .gap-2 { gap: 8px; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .flex-1 { flex: 1; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }
        .uppercase { text-transform: uppercase; }
        .tracking-widest { letter-spacing: 0.1em; }
        .text-muted { color: var(--text-muted); }
        
        /* --- SCROLLBAR --- */
        * { scrollbar-width: auto; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-bg); }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-corner { background: var(--bg-body); }
        ::-webkit-scrollbar-track { background: var(--scrollbar-bg); }
        ::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 4px; border: 2px solid var(--scrollbar-bg); }

        /* --- HEADER --- */
        header {
            padding: 12px 16px; border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-body); z-index: 30; flex: none;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-icon { padding: 8px; border-radius: 999px; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background-color: var(--bg-surface-hover); }

        .btn-new {
            display: flex; align-items: center; gap: 4px;
            padding: 6px 12px; border-radius: 999px;
            background-color: var(--primary); color: var(--on-primary);
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .btn-new:hover { opacity: 0.8; }

        .date-bar {
            padding: 12px; background-color: var(--bg-surface); flex: none;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: center; align-items: center; gap: 24px;
        }
        .date-bar button { color: var(--text-muted); font-size: 1.2rem; }
        .date-bar button:hover { color: var(--text-main); }
        
        /* --- LAYOUT --- */
        #mainContent {
            flex: 1; display: flex; flex-direction: column;
            overflow: hidden; min-height: 0; position: relative;
        }
        #calendarHeader { 
            flex: none; display: flex; 
            border-bottom: 1px solid var(--border-color); 
            background-color: var(--bg-body); overflow: hidden; 
            box-sizing: border-box; 
        }
        #habitsContainer { 
            flex: 1; overflow-y: auto; overflow-x: auto; position: relative; 
            background-color: var(--bg-body);
        }

        /* --- QUOTE SECTION --- */
        #quoteContainer {
            flex: none; height: 140px; 
            border-top: 1px solid var(--border-color); background-color: var(--bg-surface);
            padding: 16px; display: flex; align-items: center; justify-content: center;
            text-align: center; cursor: pointer; transition: background-color 0.2s; position: relative;
        }
        #quoteContainer:hover { background-color: var(--bg-surface-hover); }
        #quoteDisplay { width: 100%; white-space: pre-wrap; line-height: 1.3; font-weight: 500; color: var(--text-main); opacity: 0.9; }

        /* --- GRID STYLES --- */
        .row-structure { display: flex; width: 100%; min-width: max-content; }

        .sticky-col-left {
            position: sticky; left: 0; z-index: 40; /* FIX: Z-index mayor */
            background-color: var(--bg-body); /* FIX: Color solido para no ver a trav√©s */
            border-right: 1px solid var(--border-color);
            width: 220px; flex-shrink: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); /* Sombra para separar visualmente al hacer scroll */
        }
        .sticky-col-right {
            position: sticky; right: 0; z-index: 40;
            background-color: var(--bg-body);
            border-left: 1px solid var(--border-color);
            width: 50px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }

        .grid-header-cell {
            padding: 12px; height: 100%;
            font-size: 0.75rem; font-weight: 700; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.05em;
            display: flex; align-items: center;
        }

        .days-container { display: flex; flex: 1; }

        .day-header {
            flex: 1; min-width: 34px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 8px 0; border-right: 1px solid var(--border-color);
            color: var(--text-muted); transition: all 0.5s;
        }
        .day-header.today {
            background-color: var(--primary); color: var(--on-primary);
            border-bottom-left-radius: 6px; border-bottom-right-radius: 6px;
        }
        .week-separator { border-right: 1px solid var(--border-color); position: relative; }
        
        .cell-btn {
            flex: 1; min-width: 34px;
            border-right: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; user-select: none; font-size: 0.9rem;
            position: relative;
        }
        .cell-btn:active { transform: scale(0.9); }
        .cell-btn.today-border { border-bottom: 2px solid var(--text-main); }

        .state-fail { color: #ef4444; }
        .state-skip { background-color: var(--bg-surface); color: var(--text-muted); font-weight: bold; }
        html.dark .state-skip { background-color: #1a1a1a; color: #888888; }

        /* --- CATEGORY & ROWS --- */
        .category-group-header {
            display: flex; width: 100%; min-width: max-content;
            background-color: var(--bg-surface); border-bottom: 1px solid var(--border-color);
            position: sticky; left: 0;
        }
        .cat-header-sticky {
            width: 220px; flex-shrink: 0; padding: 6px 12px;
            font-size: 0.7rem; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase;
            color: var(--text-muted); display: flex; align-items: center; justify-content: space-between;
            background-color: var(--bg-surface); border-right: 1px solid var(--border-color);
            position: sticky; left: 0; z-index: 45; /* FIX: Mayor que los h√°bitos */
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        .cat-info { display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1; }
        .cat-info:hover { color: var(--text-main); }
        
        /* FIX: Botones de men√∫ siempre visibles pero sutiles */
        .menu-btn-shared { 
            opacity: 1; 
            color: var(--border-color); 
            padding: 2px 6px; border-radius: 4px; transition: all 0.2s; font-size: 1.1em; cursor: pointer; 
        }
        html.dark .menu-btn-shared { color: #333; }
        .menu-btn-shared:hover, .cat-header-sticky:hover .menu-btn-shared, .subcat-label:hover .menu-btn-shared { 
            background-color: var(--bg-surface-hover); color: var(--text-main); 
        }

        .cat-header-fill { flex: 1; background-color: var(--bg-surface); }
        .cat-status-dot { width: 8px; height: 8px; border-radius: 50%; margin-left: 8px; flex-shrink: 0; transition: background-color 0.3s, box-shadow 0.3s; }

        /* --- SUBCATEGORY ROW --- */
        .subcategory-row {
            display: flex; width: 100%; min-width: max-content;
            background-color: var(--bg-surface); border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        .subcategory-row.drag-over { background-color: var(--bg-surface-hover); }
        
        .subcat-label {
            width: 220px; position: sticky; left: 0; z-index: 42; padding: 4px 12px;
            font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
            color: var(--text-muted); opacity: 0.9; letter-spacing: 0.05em;
            background-color: var(--bg-surface); border-right: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        .subcat-click-area { display: flex; align-items: center; gap: 6px; cursor: pointer; flex: 1; height: 100%; }
        .subcat-line { flex: 1; opacity: 0.1; background-image: linear-gradient(90deg, var(--text-muted) 30%, transparent 0%); background-size: 6px 1px; background-repeat: repeat-x; background-position: center; }

        /* ROWS */
        .habit-row {
            min-height: 56px; border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-body); transition: background-color 0.2s;
        }
        .habit-row:hover { background-color: var(--bg-surface-hover); }
        .habit-row.dragging { opacity: 0.4; }
        .habit-name-cell {
            width: 220px; flex-shrink: 0; padding-left: 8px; padding-right: 4px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .drag-handle { cursor: grab; margin-right: 6px; color: var(--text-muted); opacity: 0.3; font-size: 1.2em; display: flex; align-items: center; }
        .habit-row:hover .drag-handle { opacity: 1; }
        .streak-badge { display: flex; align-items: center; gap: 2px; font-size: 0.7rem; font-weight: bold; color: var(--text-muted); margin-left: auto; margin-right: 6px; }
        .streak-badge.active { color: #f97316; }

        /* --- MEN√ö LATERAL --- */
        #menuOverlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 50; transition: opacity 0.3s; }
        #menuContent { position: fixed; top: 0; left: 0; height: 100%; width: 300px; background-color: var(--menu-bg); border-right: 1px solid var(--border-color); z-index: 51; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 10px 0 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        #menuContent.open { transform: translateX(0); }
        .menu-header { padding: 32px 24px 24px 24px; display: flex; justify-content: space-between; align-items: center; }
        .menu-scroll-area { flex: 1; overflow-y: auto; padding: 0 24px 32px 24px; }
        .menu-section { margin-bottom: 32px; }
        .menu-section-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); opacity: 0.7; margin-bottom: 12px; display: block; margin-left: 4px; }
        .menu-row { width: 100%; text-align: left; padding: 14px 4px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; font-weight: 500; color: var(--text-main); border-bottom: 1px solid var(--bg-surface-hover); cursor: pointer; }
        .switch-toggle { width: 40px; height: 22px; background-color: var(--bg-surface-hover); border-radius: 99px; position: relative; border: 1px solid var(--border-color); transition: background 0.3s, border-color 0.3s; cursor: pointer; }
        .switch-toggle.active { background-color: var(--text-main); border-color: var(--text-main); }
        .switch-toggle::after { content: ''; position: absolute; left: 2px; top: 2px; width: 16px; height: 16px; background-color: var(--text-muted); border-radius: 50%; transition: transform 0.3s, background-color 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .switch-toggle.active::after { transform: translateX(18px); background-color: var(--bg-body); }

        #genericModal, #newHabitModal, #confirmModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 60; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; padding: 16px; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        #genericModal.active, #newHabitModal.active, #confirmModal.active { opacity: 1; pointer-events: auto; }
        .modal-card { background-color: var(--bg-body); width: 100%; max-width: 380px; border-radius: 20px; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); border: 1px solid var(--border-color); position: relative; animation: scaleIn 0.2s ease-out; margin: 0; max-height: 80vh; overflow-y: auto; }
        input.clean-input, textarea.clean-input { width: 100%; font-size: 1.25rem; background: transparent; border: none; border-bottom: 2px solid var(--border-color); padding: 8px 0; margin-bottom: 24px; outline: none; resize: none; }
        input.clean-input:focus, textarea.clean-input:focus { border-color: var(--text-main); }
        .primary-btn { width: 100%; padding: 14px; background-color: var(--primary); color: var(--on-primary); border-radius: 12px; font-weight: bold; font-size: 0.875rem; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .secondary-btn { width: 100%; padding: 14px; background-color: var(--bg-surface); color: var(--text-main); border-radius: 12px; font-weight: bold; font-size: 0.875rem; text-align: center; }
        .option-btn { width: 100%; padding: 14px; text-align: left; border-radius: 12px; margin-bottom: 8px; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 12px; background-color: var(--bg-surface); color: var(--text-main); border: 1px solid transparent; }
        .chip { padding: 6px 12px; border-radius: 99px; font-size: 0.75rem; border: 1px solid var(--border-color); background: var(--bg-surface); cursor: pointer; color: var(--text-muted); transition: all 0.2s; }
        .chip.selected { background-color: var(--primary); color: var(--on-primary); border-color: var(--primary); }
        #toast-container { position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none; }
        .toast { background-color: var(--toast-bg); color: var(--toast-text); padding: 10px 24px; border-radius: 99px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 0.85rem; font-weight: 600; margin-top: 8px; animation: slideUp 0.3s forwards; }
        @keyframes slideUp { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes scaleIn { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .color-picker-wrapper { width: 30px; height: 30px; border-radius: 50%; overflow: hidden; border: 2px solid var(--border-color); flex-shrink: 0; cursor: pointer; }
        input[type="color"] { width: 200%; height: 200%; transform: translate(-25%, -25%); border: none; cursor: pointer; padding: 0; }
        #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 150; }
    </style>
</head>
<body>
    <canvas id="confettiCanvas"></canvas>
    <audio id="tick-audio" src="https://www.soundjay.com/clock/sounds/clock-ticking-2.mp3" preload="auto"></audio>

    <header>
        <button onclick="window.toggleMenu(true)" class="btn-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <h1 class="font-bold text-sm tracking-widest uppercase">Habit Tracker v7.2</h1>
        <button onclick="window.toggleNewHabit(true)" class="btn-new"><span>+</span> <span>Nuevo</span></button>
    </header>

    <div class="date-bar">
        <button onclick="changeMonth(-1)">&lt;</button>
        <span id="currentMonthDisplay" class="text-sm font-bold uppercase tracking-widest" style="min-width: 140px; text-align: center;">...</span>
        <button onclick="changeMonth(1)">&gt;</button>
    </div>

    <main id="mainContent">
        <div id="calendarHeader"></div>
        <div id="habitsContainer"></div>
        <div id="quoteContainer" onclick="editQuote()">
            <div id="quoteDisplay" class="empty-quote-placeholder">Haz clic para escribir una frase...</div>
        </div>
    </main>

    <div id="menuOverlay" onclick="window.toggleMenu(false)" class="hidden opacity-0 fixed inset-0"></div>
    <div id="menuContent">
        <div class="menu-header"><h3 class="font-bold text-2xl">Ajustes</h3><button onclick="window.toggleMenu(false)" class="btn-icon">‚úï</button></div>
        <div class="menu-scroll-area">
            <div class="menu-section">
                <label class="menu-section-label">General</label>
                <div class="menu-row" onclick="toggleClockSound()"><span>üïë Sonido Reloj</span><div id="toggleSound" class="switch-toggle"></div></div>
                <div class="menu-row" onclick="toggleDarkMode()"><span>üåó Modo Oscuro</span><div id="toggleDark" class="switch-toggle"></div></div>
            </div>
            <div class="menu-section">
                <label class="menu-section-label">Gesti√≥n</label>
                <div class="menu-row" onclick="openSubMenu('categories')"><span>Categor√≠as</span><span>‚Ä∫</span></div>
                <div class="menu-row" onclick="openSubMenu('archive')"><span>Archivo</span><span>‚Ä∫</span></div>
                <div class="menu-row" onclick="openSubMenu('backup')"><span>Backup</span><span>‚Ä∫</span></div>
            </div>
            <div class="danger-zone"><button onclick="resetData()" class="delete-btn" style="color:var(--danger); font-weight:bold; margin-top:20px; text-align:left; width:100%;">üóëÔ∏è Eliminar todo</button></div>
        </div>
    </div>

    <div id="genericModal" onclick="closeGenericModal()" class="hidden"><div id="gModalContent" onclick="event.stopPropagation()" class="modal-card"><button onclick="closeGenericModal()" class="absolute" style="top:16px; right:16px; color:var(--text-muted);">‚úï</button><h3 id="gModalTitle" class="font-bold text-lg mb-4">T√≠tulo</h3><div id="gModalBody"></div></div></div>
    <div id="confirmModal" onclick="closeConfirm()" class="hidden"><div class="modal-card" onclick="event.stopPropagation()"><h3 id="confirmMessage" class="font-bold text-lg mb-2">¬øEst√°s seguro?</h3><div class="flex gap-2"><button onclick="closeConfirm()" class="secondary-btn">Cancelar</button><button id="btnConfirmAction" class="primary-btn" style="background-color:var(--danger);">Confirmar</button></div></div></div>
    
    <div id="newHabitModal" onclick="window.toggleNewHabit(false)" class="hidden">
        <div onclick="event.stopPropagation()" class="modal-card">
            <h3 class="font-bold text-lg mb-6">Nuevo H√°bito</h3>
            <input type="text" id="habitNameInput" placeholder="Nombre..." class="clean-input" autocomplete="off">
            <label class="text-xs font-bold uppercase tracking-widest mb-2 block" style="color: var(--text-muted);">Categor√≠a</label>
            <div id="categoryChips" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;"></div>
            <div id="inlineCategoryCreator" class="hidden mb-4 flex gap-2 items-center"><div class="color-picker-wrapper"><input type="color" id="inlineCatColor" value="#3b82f6"></div><input id="inlineCatInput" placeholder="Categor√≠a..." style="flex:1; background:var(--bg-surface); border:1px solid var(--border-color); border-radius:8px; padding:8px;"><button onclick="createInlineCategory()" class="primary-btn" style="width:auto; padding:8px 12px; font-size:0.75rem;">OK</button></div>
            <div id="subcatSection" class="hidden"><label class="text-xs font-bold uppercase tracking-widest mb-2 block" style="color:var(--text-muted);">Subcategor√≠a</label><div id="subcatChips" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;"></div><input type="text" id="manualSubcatInput" placeholder="O escribe una nueva..." class="clean-input" style="font-size:0.9rem; padding:8px; border:1px solid var(--border-color); border-radius:8px; margin-bottom:24px;"></div>
            <button onclick="createHabit()" class="primary-btn">Crear</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        const DEFAULT_CATEGORIES = [{ id: 'gen', name: 'General', color: '#9ca3af', subcategories: [] }];
        let state = { habits: [], categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)), settings: { darkMode: true, collapsedCats: {}, collapsedSubCats: {}, clockSound: false, dailyNote: "" }, viewDate: new Date() };
        let selectedCategory = null; let selectedSubcat = ""; let confirmCallback = null; let clockInterval = null; let draggedHabitId = null;
        const tickAudio = document.getElementById('tick-audio');

        function init() {
            try {
                let loaded = JSON.parse(localStorage.getItem('habitTrackerV5'));
                if(!loaded) loaded = JSON.parse(localStorage.getItem('habitTrackerV6_3')) || JSON.parse(localStorage.getItem('habitTrackerV6_1'));
                if (loaded) {
                    state = loaded; state.viewDate = new Date(state.viewDate || new Date());
                    if(state.categories) state.categories.forEach(c => { if(!c.subcategories) c.subcategories = []; });
                    if(!state.settings.collapsedSubCats) state.settings.collapsedSubCats = {};
                }
            } catch (e) {}
            applyTheme(); updateSwitches(); renderCalendar(); renderQuote();
            if(state.settings.clockSound) playClockAudio(true);
            window.addEventListener('resize', syncHeaderWidth);
            document.getElementById('btnConfirmAction').onclick = () => { if(confirmCallback) confirmCallback(); closeConfirm(); };
        }

        function saveData() { localStorage.setItem('habitTrackerV5', JSON.stringify(state)); }
        function applyTheme() { if (state.settings.darkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }
        function updateSwitches() { const d = document.getElementById('toggleDark'), s = document.getElementById('toggleSound'); if(state.settings.darkMode) d.classList.add('active'); else d.classList.remove('active'); if(state.settings.clockSound) s.classList.add('active'); else s.classList.remove('active'); }
        function toggleClockSound() { state.settings.clockSound = !state.settings.clockSound; saveData(); updateSwitches(); playClockAudio(state.settings.clockSound); }
        function playClockAudio(play) { if(play) { tickAudio.currentTime=0; tickAudio.volume=0.3; tickAudio.play().catch(()=>{}); if(clockInterval) clearInterval(clockInterval); clockInterval = setInterval(()=>{ tickAudio.currentTime=0; tickAudio.play().catch(()=>{}); }, 1000); } else { if(clockInterval) clearInterval(clockInterval); clockInterval=null; tickAudio.pause(); } }

        /* --- DRAG DROP --- */
        function handleDragStart(e, id) { draggedHabitId = id; e.dataTransfer.effectAllowed='move'; e.target.classList.add('dragging'); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.subcategory-row').forEach(el => el.classList.remove('drag-over')); }
        function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function dropOnSubcat(e, catId, subName) { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); const h = state.habits.find(x => x.id == draggedHabitId); if(h) { const tCat = state.categories.find(c => c.id == catId); if(tCat && h.category.id != catId) h.category = tCat; h.subcategory = subName; saveData(); renderCalendar(); showToast('Movido'); } }
        function dropOnHabit(e, targetId) { e.preventDefault(); const tH = state.habits.find(h=>h.id==targetId), dH = state.habits.find(h=>h.id==draggedHabitId); if(tH && dH && targetId!=draggedHabitId) { if(dH.category.id!=tH.category.id) dH.category=tH.category; dH.subcategory=tH.subcategory; saveData(); renderCalendar(); } }

        /* --- RENDER --- */
        function renderCalendar() {
            const container = document.getElementById('habitsContainer');
            const headerContainer = document.getElementById('calendarHeader');
            container.innerHTML = ''; headerContainer.innerHTML = '';
            
            const dateStr = state.viewDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('currentMonthDisplay').innerText = dateStr;
            const year = state.viewDate.getFullYear(), month = state.viewDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const n = new Date(); const todayISO = `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;

            let headerHTML = `<div class="row-structure"><div class="sticky-col-left grid-header-cell">H√°bito</div><div class="days-container">`;
            for (let i = 1; i <= daysInMonth; i++) {
                const d = new Date(year, month, i);
                const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const sep = d.getDay() === 0 ? 'week-separator' : '';
                headerHTML += `<div class="day-header ${iso===todayISO?'today':''} ${sep}"><span>${d.toLocaleDateString('es-ES',{weekday:'narrow'})}</span><span>${i}</span></div>`;
            }
            headerHTML += `</div><div class="sticky-col-right grid-header-cell">%</div></div>`;
            headerContainer.innerHTML = headerHTML;

            const activeHabits = state.habits.filter(h => !h.archived);
            if (activeHabits.length === 0) { container.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-muted);">No hay h√°bitos.</div>`; return; }

            const grid = document.createElement('div'); grid.className = 'flex flex-col min-w-max';

            state.categories.forEach(cat => {
                const catHabits = activeHabits.filter(h => h.category.id == cat.id);
                if (catHabits.length === 0 && (!cat.subcategories || cat.subcategories.length === 0)) return;

                let dotColor = null;
                if (catHabits.length > 0) {
                    const allDone = catHabits.every(h => { const s = h.history[todayISO]; return s === 'done' || s === 'skip'; });
                    dotColor = allDone ? 'var(--success)' : 'var(--danger)';
                }
                const isCollapsed = state.settings.collapsedCats[cat.id];
                const catHead = document.createElement('div'); catHead.className = 'category-group-header';
                let dotHTML = dotColor ? `<div class="cat-status-dot" style="background:${dotColor}; box-shadow:0 0 4px ${dotColor};"></div>` : '';
                
                catHead.innerHTML = `<div class="cat-header-sticky"><div class="cat-info" onclick="toggleCategory('${cat.id}')"><span style="color:${cat.color}; font-size:0.7rem;">${isCollapsed?'‚ñ∫':'‚ñº'}</span><span>${cat.name}</span>${dotHTML}</div><button onclick="openCategoryMenu('${cat.id}')" class="menu-btn-shared">‚ãÆ</button></div><div class="cat-header-fill"></div>`;
                grid.appendChild(catHead);

                if (isCollapsed) return;

                const grouped = {};
                catHabits.forEach(h => { const s = h.subcategory ? h.subcategory.trim() : ""; if(!grouped[s]) grouped[s] = []; grouped[s].push(h); });
                const definedSubs = cat.subcategories || [];
                const allSubKeys = new Set([...Object.keys(grouped), ...definedSubs]);
                const sortedKeys = Array.from(allSubKeys).sort((a,b) => { if(a==="") return -1; if(b==="") return 1; return a.localeCompare(b); });

                sortedKeys.forEach(subKey => {
                    if(subKey !== "") {
                        let subDotColor = null;
                        const subHabits = grouped[subKey] || [];
                        if (subHabits.length > 0) {
                            const subAllDone = subHabits.every(h => { const s = h.history[todayISO]; return s === 'done' || s === 'skip'; });
                            subDotColor = subAllDone ? 'var(--success)' : 'var(--danger)';
                        }
                        const subDotHTML = subDotColor ? `<div class="cat-status-dot" style="background:${subDotColor}; margin-right:auto; margin-left:8px;"></div>` : '';

                        const subKeyId = `${cat.id}_${subKey}`;
                        const isSubCollapsed = state.settings.collapsedSubCats[subKeyId];
                        const subArrow = isSubCollapsed ? '‚ñ∫' : '‚ñº';
                        const subRow = document.createElement('div'); subRow.className = 'subcategory-row';
                        subRow.ondragover = (e) => allowDrop(e); subRow.ondragleave = (e) => handleDragLeave(e); subRow.ondrop = (e) => dropOnSubcat(e, cat.id, subKey);
                        subRow.innerHTML = `<div class="subcat-label" style="border-left:4px solid ${cat.color};"><div class="subcat-click-area" onclick="toggleSubCat('${cat.id}', '${subKey}')"><span style="font-size:0.6rem;">${subArrow}</span><span>${subKey}</span>${subDotHTML}</div><button class="menu-btn-shared" onclick="openSubcatMenu('${cat.id}', '${subKey}')">‚ãÆ</button></div><div class="subcat-line"></div>`;
                        grid.appendChild(subRow);
                        if(isSubCollapsed) return;
                    }

                    (grouped[subKey] || []).forEach(h => {
                        const row = document.createElement('div'); row.className = 'habit-row row-structure';
                        row.draggable = true; row.ondragstart = (e) => handleDragStart(e, h.id); row.ondragend = (e) => handleDragEnd(e); row.ondragover = (e) => e.preventDefault(); row.ondrop = (e) => dropOnHabit(e, h.id);

                        let streak = 0; const dNow = new Date();
                        for(let k=0;k<365;k++){ const iso = dNow.toISOString().split('T')[0]; if(h.history[iso]==='done') streak++; else if(k>0) break; dNow.setDate(dNow.getDate()-1); }

                        let cells = `<div class="sticky-col-left habit-name-cell" onclick="openHabitOptions(${h.id})"><div class="flex items-center gap-2 overflow-hidden" style="flex:1"><div class="drag-handle">::</div><div style="width:6px; height:6px; border-radius:50%; background:${cat.color}"></div><span class="text-sm font-medium truncate">${h.name}</span></div>${(h.showStreak!==false && streak>0) ? `<div class="streak-badge active">üî• ${streak}</div>` : ''}</div><div class="days-container">`;

                        let checks=0;
                        for(let i=1; i<=daysInMonth; i++) {
                            const loopIso = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                            const isToday = loopIso === todayISO;
                            const stat = h.history[loopIso];
                            if(stat==='done' || stat==='skip') checks++;
                            const dObj = new Date(year, month, i);
                            let cls = 'cell-btn ' + (dObj.getDay()===0?'week-separator ':'') + (isToday?'today-border':'');
                            let style = '', txt = '';
                            if(stat==='done') { style=`color:${cat.color}; font-weight:bold;`; txt='‚úì'; if(state.settings.cellStyle==='solid') { style=`background:${cat.color}; color:#fff;`; } }
                            else if(stat==='fail') { style='color:var(--danger);'; txt='‚úó'; }
                            else if(stat==='skip') { cls+='state-skip'; txt='‚àí'; }
                            cells += `<div onclick="toggleDay(${h.id}, '${loopIso}')" class="${cls}" style="${style}">${txt}</div>`;
                        }
                        cells += `</div><div class="sticky-col-right grid-header-cell">${Math.round((checks/daysInMonth)*100)}%</div>`;
                        row.innerHTML = cells;
                        grid.appendChild(row);
                    });
                });
            });
            container.appendChild(grid);
            container.onscroll = () => { headerContainer.scrollLeft = container.scrollLeft; };
            setTimeout(syncHeaderWidth, 0);
        }

        function syncHeaderWidth() {
            const container = document.getElementById('habitsContainer');
            const header = document.getElementById('calendarHeader');
            if(!container || !header) return;
            const scrollbarWidth = container.offsetWidth - container.clientWidth;
            header.style.paddingRight = `${scrollbarWidth}px`;
        }

        /* --- LOGIC --- */
        function toggleCategory(id) { state.settings.collapsedCats[id] = !state.settings.collapsedCats[id]; saveData(); renderCalendar(); }
        function toggleSubCat(catId, subName) { const key = `${catId}_${subName}`; state.settings.collapsedSubCats[key] = !state.settings.collapsedSubCats[key]; saveData(); renderCalendar(); }
        function toggleDay(id, iso) {
            const h = state.habits.find(x => x.id === id); if(!h) return;
            const curr = h.history[iso];
            if(!curr) { h.history[iso] = 'done'; playSound(); triggerConfetti(); } else if(curr==='done') h.history[iso] = 'fail'; else if(curr==='fail') h.history[iso] = 'skip'; else delete h.history[iso];
            saveData(); renderCalendar();
        }
        function changeMonth(d) { state.viewDate.setMonth(state.viewDate.getMonth()+d); renderCalendar(); }

        /* --- MENUS & RENAMING --- */
        function openSubcatMenu(catId, subName) {
            closeGenericModal();
            setTimeout(() => {
                const html = `
                    <div class="text-sm text-muted mb-4">Subcategor√≠a: <b>${subName}</b></div>
                    <button onclick="renameSubcat('${catId}', '${subName}')" class="option-btn">‚úèÔ∏è Renombrar</button>
                    <button onclick="startMoveSubcat('${catId}', '${subName}')" class="option-btn">üìÇ Mover a otra categor√≠a</button>
                    <button onclick="deleteSubcatDirect('${catId}', '${subName}')" class="option-btn" style="color:var(--danger)">üóëÔ∏è Eliminar Subcategor√≠a</button>
                `;
                openGenericModal('Opciones', html);
            }, 300);
        }
        
        /* RENOMBRAR SUBCATEGOR√çA */
        function renameSubcat(catId, oldName) {
            closeGenericModal();
            setTimeout(() => {
                const html = `
                    <input id="renameSubInput" class="clean-input" value="${oldName}" placeholder="Nuevo nombre...">
                    <button onclick="processRenameSubcat('${catId}', '${oldName}')" class="primary-btn">Guardar</button>
                `;
                openGenericModal('Renombrar Subcategor√≠a', html);
            }, 300);
        }
        function processRenameSubcat(catId, oldName) {
            const newName = document.getElementById('renameSubInput').value.trim();
            if(!newName || newName === oldName) { closeGenericModal(); return; }
            const cat = state.categories.find(c => c.id == catId);
            if(cat) {
                // Actualizar lista de subcategor√≠as
                const idx = cat.subcategories.indexOf(oldName);
                if(idx !== -1) cat.subcategories[idx] = newName;
                // Actualizar h√°bitos
                state.habits.forEach(h => {
                    if(h.category.id == catId && h.subcategory === oldName) {
                        h.subcategory = newName;
                    }
                });
                saveData(); renderCalendar(); closeGenericModal(); showToast('Renombrado');
            }
        }

        /* BORRAR SUBCATEGOR√çA */
        function deleteSubcatDirect(catId, subName) {
            closeGenericModal();
            showConfirm('¬øEliminar etiqueta? Los h√°bitos no se borrar√°n.', () => {
                const cat = state.categories.find(c => c.id == catId);
                if(cat) {
                    cat.subcategories = cat.subcategories.filter(s => s !== subName);
                    state.habits.forEach(h => { if(h.category.id == catId && h.subcategory === subName) { h.subcategory = ""; } });
                    saveData(); renderCalendar(); showToast('Eliminada');
                }
            });
        }
        function startMoveSubcat(currentCatId, subName) {
            closeGenericModal();
            setTimeout(() => {
                let html = '<p class="text-sm text-muted mb-2">Selecciona nueva categor√≠a:</p><div class="flex flex-col gap-2">';
                state.categories.forEach(cat => {
                    if(cat.id != currentCatId) { html += `<button onclick="processMoveSubcat('${currentCatId}', '${cat.id}', '${subName}')" class="option-btn"><div class="flex items-center gap-2"><div class="cat-color-dot" style="background:${cat.color}"></div>${cat.name}</div></button>`; }
                });
                html += '</div>';
                openGenericModal('Mover ' + subName, html);
            }, 300);
        }
        function processMoveSubcat(oldCatId, newCatId, subName) {
            const oldCat = state.categories.find(c => c.id == oldCatId);
            const newCat = state.categories.find(c => c.id == newCatId);
            if(oldCat && newCat) {
                oldCat.subcategories = oldCat.subcategories.filter(s => s !== subName);
                if(!newCat.subcategories) newCat.subcategories = [];
                if(!newCat.subcategories.includes(subName)) newCat.subcategories.push(subName);
                state.habits.forEach(h => { if(h.category.id == oldCatId && h.subcategory === subName) { h.category = newCat; } });
                saveData(); renderCalendar(); closeGenericModal(); showToast(`Movida a ${newCat.name}`);
            }
        }

        /* MENU CATEGORIA */
        function openCategoryMenu(id) {
            const cat = state.categories.find(c => c.id == id);
            openGenericModal(cat.name, `
                <button onclick="renameCategory('${id}')" class="option-btn">‚úèÔ∏è Renombrar Categor√≠a</button>
                <button onclick="promptSub('${id}')" class="option-btn">‚ûï Nueva Subcategor√≠a</button>
                <button onclick="manageSubcats('${id}')" class="option-btn">üìÇ Gestionar Subcategor√≠as</button>
                <div style="height:1px; background:var(--border-color); margin:8px 0;"></div>
                <button onclick="deleteCat('${id}')" class="option-btn" style="color:var(--danger)">üóëÔ∏è Eliminar Categor√≠a</button>
            `);
        }
        
        /* RENOMBRAR CATEGOR√çA */
        function renameCategory(id) {
            closeGenericModal();
            const cat = state.categories.find(c => c.id == id);
            setTimeout(() => {
                openGenericModal('Renombrar Categor√≠a', `
                    <input id="renameCatInput" class="clean-input" value="${cat.name}">
                    <button onclick="saveRenamedCategory('${id}')" class="primary-btn">Guardar</button>
                `);
            }, 300);
        }
        function saveRenamedCategory(id) {
            const val = document.getElementById('renameCatInput').value.trim();
            if(val) {
                const cat = state.categories.find(c => c.id == id);
                cat.name = val;
                // Actualizar referencias en h√°bitos
                state.habits.forEach(h => { if(h.category.id == id) h.category.name = val; });
                saveData(); renderCalendar(); closeGenericModal();
            }
        }

        function promptSub(id) {
            closeGenericModal(); setTimeout(()=>{
                openGenericModal('Nueva Subcategor√≠a', `<input id="subIn" class="clean-input" placeholder="Nombre..." onkeyup="if(event.key==='Enter') saveSub('${id}')"><button onclick="saveSub('${id}')" class="primary-btn">Guardar</button>`);
                setTimeout(()=>document.getElementById('subIn').focus(),300);
            },300);
        }
        function saveSub(id) {
            const n = document.getElementById('subIn').value.trim();
            if(n) { 
                const cat = state.categories.find(c => c.id == id);
                if(cat) {
                    if(!cat.subcategories) cat.subcategories = [];
                    if(!cat.subcategories.includes(n)) { cat.subcategories.push(n); saveData(); showToast('A√±adida'); } else { showToast('Ya existe'); }
                    closeGenericModal(); renderCalendar(); setTimeout(() => manageSubcats(id), 350);
                }
            }
        }
        function deleteCat(id) {
            closeGenericModal();
            showConfirm('¬øBorrar categor√≠a y sus h√°bitos?', () => { 
                state.habits = state.habits.filter(h => h.category.id != id);
                state.categories = state.categories.filter(c => c.id != id); 
                saveData(); renderCalendar(); 
            });
        }
        function manageSubcats(catId) {
            closeGenericModal();
            setTimeout(() => {
                const cat = state.categories.find(c => c.id == catId);
                if(!cat || !cat.subcategories) return;
                let html = '<div style="display:flex; flex-direction:column; gap:8px;">';
                if(cat.subcategories.length === 0) { html += '<p class="text-sm text-muted">No hay subcategor√≠as.</p>'; } 
                else { cat.subcategories.forEach(sub => { html += `<div style="display:flex; justify-content:space-between; padding:12px; background:var(--bg-surface); border-radius:8px;"><span class="text-sm">${sub}</span><button onclick="deleteSub('${catId}', '${sub}')" style="color:var(--danger); font-weight:bold;">‚úï</button></div>`; }); }
                html += '</div><div style="margin-top:16px; border-top:1px solid var(--border-color); padding-top:12px;"><button onclick="closeGenericModal()" class="secondary-btn" style="width:100%">Cerrar</button></div>';
                openGenericModal('Subcategor√≠as: ' + cat.name, html);
            }, 300);
        }
        function deleteSub(catId, subName) {
            const cat = state.categories.find(c => c.id == catId);
            if(cat) {
                cat.subcategories = cat.subcategories.filter(s => s !== subName);
                state.habits.forEach(h => { if(h.category.id == catId && h.subcategory === subName) { h.subcategory = ""; } });
                saveData(); closeGenericModal(); setTimeout(() => manageSubcats(catId), 300); renderCalendar();
            }
        }

        /* --- OTHERS --- */
        window.toggleMenu = function(show) { const o = document.getElementById('menuOverlay'), c = document.getElementById('menuContent'); if(show){ o.classList.remove('hidden'); setTimeout(() => { o.classList.remove('opacity-0'); c.classList.add('open'); }, 10); } else { o.classList.add('opacity-0'); c.classList.remove('open'); setTimeout(() => o.classList.add('hidden'), 300); } }
        function openSubMenu(type) {
            window.toggleMenu(false);
            if (type === 'categories') {
                let html = '<div style="display:flex; flex-direction:column; gap:8px;">';
                state.categories.forEach((c, i) => { html += `<div class="cat-list-item"><div class="flex items-center"><span class="cat-color-dot" style="background-color: ${c.color}"></span><span class="font-medium text-sm">${c.name}</span></div><button onclick="removeCategory(${i})" style="color: var(--text-muted); font-size: 0.7rem;">ELIMINAR</button></div>`; });
                html += `</div><div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);"><label class="text-xs font-bold uppercase tracking-widest" style="color: var(--text-muted); display: block; margin-bottom: 8px;">Nueva Categor√≠a</label><div class="flex gap-2 items-center relative"><div class="color-picker-wrapper"><input type="color" id="newCatColorInput" value="#10b981"></div><input id="newCatInput" placeholder="Ej: Deportes..." style="flex:1; background: var(--bg-surface); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); outline: none;"><button onclick="addCategory()" class="primary-btn" style="padding: 0 12px; height: 38px;">+</button></div></div>`;
                openGenericModal('Gestionar Categor√≠as', html);
            } 
            else if (type === 'archive') { /* ... */ } 
            else if (type === 'backup') { openGenericModal('Backup', `<button onclick="downloadData()" class="primary-btn" style="margin-bottom:12px;">Descargar Backup</button><input type="file" onchange="uploadData(this)" style="display:block; width:100%; font-size:0.8rem; color:var(--text-muted);">`); }
        }
        function addCategory() { const i = document.getElementById('newCatInput'), cIn = document.getElementById('newCatColorInput'); if(i.value.trim()){ state.categories.push({id:Date.now(), name:i.value.trim(), color: cIn.value, subcategories:[]}); saveData(); openSubMenu('categories'); } }
        function removeCategory(i) { closeGenericModal(); const cat = state.categories[i]; showConfirm('¬øEliminar esta categor√≠a?', () => { state.categories.splice(i,1); if(cat) state.habits = state.habits.filter(h => h.category.id != cat.id); saveData(); showToast('Categor√≠a eliminada'); openSubMenu('categories'); renderCalendar(); }); }
        
        window.toggleNewHabit = function(show) { const el = document.getElementById('newHabitModal'); if(show) { selectedCategory = state.categories[0]; selectedSubcat = ""; if(state.categories.length === 0) toggleInlineCreator(true); else { toggleInlineCreator(false); renderCategoryChips(); } document.getElementById('habitNameInput').value = ""; document.getElementById('manualSubcatInput').value = ""; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('active'),10); setTimeout(() => document.getElementById('habitNameInput').focus(), 100); } else { el.classList.remove('active'); setTimeout(()=>el.classList.add('hidden'),200); } }
        function renderCategoryChips() { const c = document.getElementById('categoryChips'); c.innerHTML=''; state.categories.forEach(cat => { const d = document.createElement('div'); d.className = `chip ${selectedCategory.id===cat.id?'selected':''}`; d.innerText = cat.name; d.onclick = () => { selectedCategory = cat; selectedSubcat = ""; renderCategoryChips(); }; c.appendChild(d); }); renderSubcatChips(); }
        function renderSubcatChips() { const s = document.getElementById('subcatSection'), c = document.getElementById('subcatChips'); c.innerHTML=''; s.classList.remove('hidden'); if(selectedCategory.subcategories && selectedCategory.subcategories.length > 0) { selectedCategory.subcategories.forEach(sub => { const d = document.createElement('div'); d.className = `chip ${selectedSubcat===sub?'selected':''}`; d.innerText = sub; d.onclick = () => { selectedSubcat = (selectedSubcat===sub)?"":sub; renderSubcatChips(); }; c.appendChild(d); }); } else { c.innerHTML = '<span class="text-xs text-muted">Sin subcategor√≠as guardadas.</span>'; } }
        function createHabit() { const n = document.getElementById('habitNameInput').value.trim(); const m = document.getElementById('manualSubcatInput').value.trim(); let finalSub = selectedSubcat || m; if(!n) return showToast('Falta el nombre'); if(!selectedCategory) return showToast('Elige categor√≠a'); if(finalSub && !selectedCategory.subcategories.includes(finalSub)) { selectedCategory.subcategories.push(finalSub); } state.habits.push({ id:Date.now(), name:n, category:selectedCategory, subcategory:finalSub, history:{}, archived:false, created:new Date().toISOString() }); saveData(); window.toggleNewHabit(false); renderCalendar(); showToast('H√°bito creado'); }
        function toggleInlineCreator(show) { const chipC = document.getElementById('categoryChips'), creator = document.getElementById('inlineCategoryCreator'); if(show) { chipC.classList.add('hidden'); creator.classList.remove('hidden'); creator.classList.add('flex'); } else { chipC.classList.remove('hidden'); creator.classList.add('hidden'); creator.classList.remove('flex'); } }
        function createInlineCategory() { const i = document.getElementById('inlineCatInput'), c = document.getElementById('inlineCatColor'); if(i.value.trim()){ const nc={id:Date.now(), name:i.value.trim(), color:c.value, subcategories:[]}; state.categories.push(nc); selectedCategory=nc; saveData(); renderCategoryChips(); toggleInlineCreator(false); } }

        function openGenericModal(t, c) { document.getElementById('gModalTitle').innerText=t; document.getElementById('gModalBody').innerHTML=c; const el=document.getElementById('genericModal'); el.classList.remove('hidden'); setTimeout(()=>el.classList.add('active'),10); }
        function closeGenericModal() { const el=document.getElementById('genericModal'); el.classList.remove('active'); setTimeout(()=>el.classList.add('hidden'),200); }
        function showConfirm(m, cb) { document.getElementById('confirmMessage').innerText=m; confirmCallback=cb; const el=document.getElementById('confirmModal'); el.classList.remove('hidden'); setTimeout(()=>el.classList.add('active'),10); }
        function closeConfirm() { const el=document.getElementById('confirmModal'); el.classList.remove('active'); setTimeout(()=>el.classList.add('hidden'),200); confirmCallback=null; }
        function showToast(m) { const t=document.createElement('div'); t.className='toast'; t.innerText=m; document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(),3000); }
        function editQuote() { openGenericModal('Frase', `<textarea id="qIn" class="clean-input">${state.settings.dailyNote||""}</textarea><button onclick="saveQ()" class="primary-btn">Guardar</button>`); }
        function saveQ() { state.settings.dailyNote = document.getElementById('qIn').value; saveData(); renderQuote(); closeGenericModal(); }
        function renderQuote() { document.getElementById('quoteDisplay').innerText = state.settings.dailyNote || "Haz clic para escribir una frase..."; }
        
        /* HABIT OPTIONS & RENAMING */
        function openHabitOptions(id) { 
            const h = state.habits.find(x => x.id === id); 
            openGenericModal(h.name, `
                <button onclick="renameHabit(${id})" class="option-btn">‚úèÔ∏è Renombrar</button>
                <button onclick="deleteHabit(${id})" class="option-btn" style="color:var(--danger)">üóëÔ∏è Eliminar</button>
            `); 
        }
        function renameHabit(id) {
            closeGenericModal();
            const h = state.habits.find(x => x.id === id);
            setTimeout(() => {
                openGenericModal('Renombrar H√°bito', `
                    <input id="renameHabitInput" class="clean-input" value="${h.name}">
                    <button onclick="saveRenamedHabit(${id})" class="primary-btn">Guardar</button>
                `);
            }, 300);
        }
        function saveRenamedHabit(id) {
            const val = document.getElementById('renameHabitInput').value.trim();
            if(val) {
                const h = state.habits.find(x => x.id === id);
                h.name = val;
                saveData(); renderCalendar(); closeGenericModal();
            }
        }

        function deleteHabit(id) { closeGenericModal(); state.habits=state.habits.filter(h=>h.id!==id); saveData(); renderCalendar(); showToast('Eliminado'); }
        function resetData() { localStorage.clear(); location.reload(); }
        function toggleDarkMode() { state.settings.darkMode=!state.settings.darkMode; applyTheme(); updateSwitches(); saveData(); }
        function unarchive(id) { state.habits.find(h=>h.id===id).archived=false; saveData(); renderCalendar(); closeGenericModal(); showToast('Recuperado'); }
        function downloadData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state)); a.download="habit_tracker_backup.json"; a.click(); }
        function uploadData(i) { const r=new FileReader(); r.onload=e=>{ try{state=JSON.parse(e.target.result);saveData();location.reload();}catch(x){showToast('Error archivo');}}; r.readAsText(i.files[0]); }
        function playSound() { try { const c=new(window.AudioContext||window.webkitAudioContext); const o=c.createOscillator();const g=c.createGain(); o.connect(g);g.connect(c.destination); o.frequency.value=800; g.gain.setValueAtTime(0.05,c.currentTime); g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.05); o.start();o.stop(c.currentTime+0.05); } catch(e){} }
        function triggerConfetti() { const c=document.getElementById('confettiCanvas'); const x=c.getContext('2d'); c.width=window.innerWidth; c.height=window.innerHeight; const p=[]; for(let i=0;i<40;i++) p.push({x:Math.random()*c.width, y:-20, vx:(Math.random()-0.5)*5, vy:Math.random()*5+2, c:'#fbbf24', l:100}); function a(){x.clearRect(0,0,c.width,c.height); p.forEach(e=>{if(e.l>0){e.x+=e.vx;e.y+=e.vy;e.l--;x.fillStyle=e.c;x.fillRect(e.x,e.y,6,6);}}); requestAnimationFrame(a);} a(); }

        init();
    </script>
</body>
</html>
