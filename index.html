<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Habit Tracker v8.3 - Tooltips Corregidos</title>
    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-body: #ffffff;
            --bg-surface: #f9fafb;
            --bg-surface-hover: #f3f4f6;
            --text-main: #111827;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --divider-strong: #9ca3af;
            --primary: #000000;
            --on-primary: #ffffff;
            --danger: #ef4444;
            --success: #22c55e;
            --toast-bg: #111111;
            --toast-text: #ffffff;
            --scrollbar-thumb: #9ca3af;
            --scrollbar-bg: #e5e7eb;
            --menu-bg: #ffffff;
        }

        html.dark {
            --bg-body: #050505;
            --bg-surface: #111111;
            --bg-surface-hover: #1f1f1f;
            --text-main: #e0e0e0;
            --text-muted: #6b7280;
            --border-color: #222222;
            --divider-strong: #4b5563;
            --primary: #ffffff;
            --on-primary: #000000;
            --danger: #ef4444;
            --success: #22c55e;
            --toast-bg: #ffffff;
            --toast-text: #000000;
            --scrollbar-thumb: #333333;
            --scrollbar-bg: #000000;
            --menu-bg: #0a0a0a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            position: fixed; inset: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
            zoom: 0.85; 
        }

        button { background: none; border: none; cursor: pointer; color: inherit; font-family: inherit; outline: none; }
        input, textarea, select { font-family: inherit; color: inherit; }
        
        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .gap-2 { gap: 8px; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .flex-1 { flex: 1; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }
        .uppercase { text-transform: uppercase; }
        .tracking-widest { letter-spacing: 0.1em; }
        .text-muted { color: var(--text-muted); }
        
        /* --- SCROLLBAR --- */
        * { scrollbar-width: auto; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-bg); }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-corner { background: var(--bg-body); }
        ::-webkit-scrollbar-track { background: var(--scrollbar-bg); }
        ::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 4px; border: 2px solid var(--scrollbar-bg); }

        /* --- HEADER --- */
        header {
            padding: 12px 16px; border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-body); z-index: 30; flex: none;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-icon { padding: 8px; border-radius: 999px; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background-color: var(--bg-surface-hover); }

        .btn-new {
            display: flex; align-items: center; gap: 4px;
            padding: 6px 12px; border-radius: 999px;
            background-color: var(--primary); color: var(--on-primary);
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .btn-new:hover { opacity: 0.8; }

        .date-bar {
            padding: 12px; background-color: var(--bg-surface); flex: none;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: center; align-items: center; gap: 24px;
        }
        .date-bar button { color: var(--text-muted); font-size: 1.2rem; }
        .date-bar button:hover { color: var(--text-main); }
        
        /* --- LAYOUT --- */
        #mainContent {
            flex: 1; display: flex; flex-direction: column;
            overflow: hidden; min-height: 0; position: relative;
        }
        #calendarHeader { 
            flex: none; display: flex; 
            border-bottom: 1px solid var(--border-color); 
            background-color: var(--bg-body); overflow: hidden; 
            box-sizing: border-box; 
        }
        #habitsContainer { 
            flex: 1; overflow-y: auto; overflow-x: auto; position: relative; 
            background-color: var(--bg-body);
        }

        /* --- QUOTE --- */
        #quoteContainer {
            flex: none; height: 140px; 
            border-top: 1px solid var(--border-color); background-color: var(--bg-surface);
            padding: 16px; display: flex; align-items: center; justify-content: center;
            text-align: center; cursor: pointer; transition: background-color 0.2s; position: relative;
        }
        #quoteContainer:hover { background-color: var(--bg-surface-hover); }
        #quoteDisplay { width: 100%; white-space: pre-wrap; line-height: 1.3; font-weight: 500; color: var(--text-main); opacity: 0.9; }

        /* --- GRID --- */
        .row-structure { display: flex; width: 100%; min-width: max-content; }

        .sticky-col-left {
            position: sticky; left: 0; z-index: 20;
            background-color: var(--bg-body);
            border-right: 1px solid var(--border-color);
            width: 220px; flex-shrink: 0;
        }
        .sticky-col-right {
            position: sticky; right: 0; z-index: 20;
            background-color: var(--bg-body);
            border-left: 1px solid var(--border-color);
            width: 50px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }

        .grid-header-cell {
            padding: 12px; height: 100%;
            font-size: 0.75rem; font-weight: 700; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.05em;
            display: flex; align-items: center;
        }

        .days-container { display: flex; flex: 1; }

        .day-header {
            flex: 1; min-width: 34px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 8px 0; border-right: 1px solid var(--border-color);
            color: var(--text-muted); transition: all 0.5s;
        }
        .day-header.today {
            background-color: var(--primary); color: var(--on-primary);
            border-bottom-left-radius: 6px; border-bottom-right-radius: 6px;
        }
        
        .week-separator { 
            border-right: 4px solid var(--divider-strong) !important; 
            position: relative; 
            z-index: 5;
        }
        
        .cell-btn {
            flex: 1; min-width: 34px;
            border-right: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; user-select: none; font-size: 0.9rem;
            position: relative;
            transition: background-color 0.1s;
        }
        .cell-btn:active { transform: scale(0.95); }
        .cell-btn.today-border { border-bottom: 2px solid var(--text-main); }
        
        .state-skip { background-color: var(--bg-surface); color: var(--text-muted); font-weight: bold; }
        html.dark .state-skip { background-color: #1a1a1a; color: #888888; } 

        /* --- NOTES & TOOLTIPS --- */
        .note-indicator {
            position: absolute; top: 0; right: 0;
            width: 0; height: 0;
            border-style: solid; border-width: 0 8px 8px 0;
            border-color: transparent var(--text-main) transparent transparent;
            opacity: 0.6; pointer-events: none;
        }
        #customTooltip {
            position: fixed; background: var(--bg-surface); color: var(--text-main);
            padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border-color);
            font-size: 0.85rem; font-weight: 500; box-shadow: 0 4px 25px rgba(0,0,0,0.4);
            pointer-events: none; z-index: 999; opacity: 0; transition: opacity 0.2s;
            max-width: 250px; white-space: pre-wrap; transform: translate(15px, 15px);
            backdrop-filter: blur(10px);
        }

        /* --- CATEGORY & ROWS --- */
        .category-group-header {
            display: flex; width: 100%; min-width: max-content;
            background-color: var(--bg-surface); border-bottom: 1px solid var(--border-color);
            position: sticky; left: 0;
        }
        .cat-header-sticky {
            width: 220px; flex-shrink: 0; padding: 6px 12px;
            font-size: 0.7rem; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase;
            color: var(--text-muted); display: flex; align-items: center; justify-content: space-between;
            background-color: var(--bg-surface); border-right: 1px solid var(--border-color);
            position: sticky; left: 0; z-index: 25;
        }
        .cat-info { display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1; }
        .cat-info:hover { color: var(--text-main); }
        .menu-btn-shared { opacity: 0; padding: 2px 6px; border-radius: 4px; transition: all 0.2s; font-size: 1.1em; cursor: pointer; color: var(--text-muted); }
        .menu-btn-shared:hover { background-color: var(--bg-surface-hover); color: var(--text-main); }
        .cat-header-sticky:hover .menu-btn-shared { opacity: 1; }
        .cat-header-fill { flex: 1; background-color: var(--bg-surface); }
        
        .cat-status-dot { width: 8px; height: 8px; border-radius: 50%; margin-left: 8px; flex-shrink: 0; transition: background-color 0.3s, box-shadow 0.3s; }

        /* --- SUBCATEGORY --- */
        .subcategory-row {
            display: flex; width: 100%; min-width: max-content;
            background-color: var(--bg-surface); border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        .subcategory-row.drag-over { background-color: var(--bg-surface-hover); }
        
        .subcat-label {
            width: 220px; position: sticky; left: 0; z-index: 22; padding: 4px 12px;
            font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
            color: var(--text-muted); opacity: 0.9; letter-spacing: 0.05em;
            background-color: var(--bg-surface); border-right: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
        }
        .subcat-click-area { display: flex; align-items: center; gap: 6px; cursor: pointer; flex: 1; height: 100%; }
        .subcat-label:hover .menu-btn-shared { opacity: 1; }
        .subcat-line { flex: 1; opacity: 0.1; background-image: linear-gradient(90deg, var(--text-muted) 30%, transparent 0%); background-size: 6px 1px; background-repeat: repeat-x; background-position: center; }

        /* --- HABIT ROW --- */
        .habit-row {
            min-height: 56px; border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-body); transition: background-color 0.2s;
        }
        .habit-row:hover { background-color: var(--bg-surface-hover); }
        .habit-row.dragging { opacity: 0.4; }
        .habit-name-cell {
            width: 220px; flex-shrink: 0; padding-left: 8px; padding-right: 4px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .drag-handle { cursor: grab; margin-right: 6px; color: var(--text-muted); opacity: 0.3; font-size: 1.2em; display: flex; align-items: center; }
        .habit-row:hover .drag-handle { opacity: 1; }
        .streak-badge { display: flex; align-items: center; gap: 2px; font-size: 0.7rem; font-weight: bold; color: var(--text-muted); margin-left: auto; margin-right: 6px; }
        .streak-badge.active { color: #f97316; }

        /* --- MENUS --- */
        #menuOverlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 50; transition: opacity 0.3s; }
        #menuContent { position: fixed; top: 0; left: 0; height: 100%; width: 300px; background-color: var(--menu-bg); border-right: 1px solid var(--border-color); z-index: 51; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 10px 0 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        #menuContent.open { transform: translateX(0); }
        .menu-header { padding: 32px 24px 24px 24px; display: flex; justify-content: space-between; align-items: center; }
        .menu-scroll-area { flex: 1; overflow-y: auto; padding: 0 24px 32px 24px; }
        .menu-section { margin-bottom: 32px; }
        .menu-section-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); opacity: 0.7; margin-bottom: 12px; display: block; margin-left: 4px; }
        .menu-row { width: 100%; text-align: left; padding: 14px 4px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; font-weight: 500; color: var(--text-main); border-bottom: 1px solid var(--bg-surface-hover); cursor: pointer; }
        
        .cat-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--bg-surface-hover); }
        .color-dot-container { position: relative; width: 16px; height: 16px; border-radius: 50%; overflow: hidden; border: 1px solid var(--border-color); margin-right: 10px; flex-shrink: 0; }
        .color-dot-input { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; cursor: pointer; border: none; padding: 0; margin: 0; }
        
        .switch-toggle { width: 40px; height: 22px; background-color: var(--bg-surface-hover); border-radius: 99px; position: relative; border: 1px solid var(--border-color); transition: background 0.3s, border-color 0.3s; cursor: pointer; }
        .switch-toggle.active { background-color: var(--text-main); border-color: var(--text-main); }
        .switch-toggle::after { content: ''; position: absolute; left: 2px; top: 2px; width: 16px; height: 16px; background-color: var(--text-muted); border-radius: 50%; transition: transform 0.3s, background-color 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .switch-toggle.active::after { transform: translateX(18px); background-color: var(--bg-body); }

        #genericModal, #newHabitModal, #confirmModal, #noteModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 60; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; padding: 16px; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        #genericModal.active, #newHabitModal.active, #confirmModal.active, #noteModal.active { opacity: 1; pointer-events: auto; }
        
        .modal-card { background-color: var(--bg-body); width: 100%; max-width: 400px; border-radius: 20px; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.4); border: 1px solid var(--border-color); position: relative; animation: scaleIn 0.2s ease-out; margin: 0; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        input.clean-input, textarea.clean-input { width: 100%; font-size: 1.25rem; background: transparent; border: none; border-bottom: 2px solid var(--border-color); padding: 8px 0; margin-bottom: 24px; outline: none; resize: none; }
        input.clean-input:focus, textarea.clean-input:focus { border-color: var(--text-main); }
        
        .primary-btn { width: 100%; padding: 14px; background-color: var(--primary); color: var(--on-primary); border-radius: 12px; font-weight: bold; font-size: 0.875rem; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .secondary-btn { width: 100%; padding: 14px; background-color: var(--bg-surface); color: var(--text-main); border-radius: 12px; font-weight: bold; font-size: 0.875rem; text-align: center; }
        .option-btn { width: 100%; padding: 14px; text-align: left; border-radius: 12px; margin-bottom: 8px; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 12px; background-color: var(--bg-surface); color: var(--text-main); border: 1px solid transparent; }
        
        #toast-container { position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none; }
        .toast { background-color: var(--toast-bg); color: var(--toast-text); padding: 10px 24px; border-radius: 99px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 0.85rem; font-weight: 600; margin-top: 8px; animation: slideUp 0.3s forwards; }
        
        @keyframes slideUp { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes scaleIn { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .color-picker-wrapper { width: 30px; height: 30px; border-radius: 50%; overflow: hidden; border: 2px solid var(--border-color); flex-shrink: 0; cursor: pointer; }
        input[type="color"] { width: 200%; height: 200%; transform: translate(-25%, -25%); border: none; cursor: pointer; padding: 0; }
        #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 150; }

        /* --- MODAL TABS --- */
        .tabs-header { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; gap: 16px; }
        .tab-btn { padding: 8px 0; font-size: 0.85rem; font-weight: 700; color: var(--text-muted); border-bottom: 2px solid transparent; transition: all 0.2s; flex: 1; text-align: center; text-transform: uppercase; letter-spacing: 0.05em; }
        .tab-btn:hover { color: var(--text-main); }
        .tab-btn.active { color: var(--text-main); border-bottom-color: var(--primary); }
        
        .cat-select-dropdown { width: 100%; padding: 10px; background: var(--bg-surface); color: var(--text-main); border: 1px solid var(--border-color); border-radius: 10px; font-size: 0.9rem; outline: none; margin-bottom: 16px; }

        /* --- ICON BUTTONS --- */
        .action-icon-btn { padding: 8px; border-radius: 8px; color: var(--text-muted); display:flex; align-items:center; justify-content:center; transition: all 0.2s; }
        .action-icon-btn:hover { background: var(--bg-surface-hover); color: var(--text-main); }
        .action-icon-btn.danger:hover { background: #fee2e2; color: var(--danger); }
        html.dark .action-icon-btn.danger:hover { background: #3f1212; }

        /* --- MODAL (v7.5) --- */
        .modern-modal-content {
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 32px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 24px;
            animation: scaleIn 0.2s ease-out;
            position: relative;
        }

        .modal-header { margin-bottom: 8px; }
        .modal-title { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.02em; color: var(--text-main); margin-bottom: 4px; }
        .modal-subtitle { font-size: 0.85rem; color: var(--text-muted); }

        .input-group { position: relative; display: flex; flex-direction: column; gap: 8px; }
        .input-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
        .modern-input { background-color: var(--bg-surface); border: 2px solid transparent; border-radius: 12px; padding: 14px 16px; font-size: 1rem; color: var(--text-main); width: 100%; outline: none; transition: all 0.2s; }
        .modern-input:focus { background-color: var(--bg-body); border-color: var(--primary); box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1); }

        .chips-scroll-area { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; }

        .chip-modern { padding: 8px 16px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; background-color: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-muted); cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; align-items: center; gap: 6px; user-select: none; }
        .chip-modern:hover { background-color: var(--bg-surface-hover); color: var(--text-main); transform: translateY(-1px); }
        .chip-modern.active { background-color: var(--primary); color: var(--on-primary); border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .chip-dot { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; opacity: 0.7; }

        .creator-box { display: flex; gap: 8px; align-items: center; background: var(--bg-surface-hover); padding: 6px; border-radius: 14px; animation: fadeIn 0.2s ease-out; }
        .creator-btn-ok { background: var(--primary); color: var(--on-primary); border-radius: 10px; padding: 0 16px; height: 42px; font-weight: bold; font-size: 0.8rem; display: flex; align-items: center; transition: transform 0.1s; }
        .creator-btn-ok:active { transform: scale(0.95); }

        .mini-btn { font-size: 0.7rem; font-weight: 700; padding: 4px 8px; background: var(--bg-surface-hover); border-radius: 6px; color: var(--primary); cursor: pointer; }
        .mini-btn:hover { background: var(--border-color); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <canvas id="confettiCanvas"></canvas>
    
    <header>
        <button onclick="window.toggleMenu(true)" class="btn-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <h1 class="font-bold text-sm tracking-widest uppercase">Habit Tracker</h1>
        <button onclick="window.toggleNewHabit(true)" class="btn-new"><span>+</span> <span>Nuevo</span></button>
    </header>

    <div class="date-bar">
        <button onclick="changeMonth(-1)">&lt;</button>
        <span id="currentMonthDisplay" class="text-sm font-bold uppercase tracking-widest" style="min-width: 140px; text-align: center;">...</span>
        <button onclick="changeMonth(1)">&gt;</button>
    </div>

    <main id="mainContent">
        <div id="calendarHeader"></div>
        <div id="habitsContainer"></div>
        <div id="quoteContainer" onclick="editQuote()">
            <div id="quoteDisplay" class="empty-quote-placeholder">Haz clic para escribir una frase...</div>
        </div>
    </main>

    <div id="menuOverlay" onclick="window.toggleMenu(false)" class="hidden opacity-0 fixed inset-0"></div>
    <div id="menuContent">
        <div class="menu-header"><h3 class="font-bold text-2xl">Ajustes</h3><button onclick="window.toggleMenu(false)" class="btn-icon">‚úï</button></div>
        <div class="menu-scroll-area">
            <div class="menu-section">
                <label class="menu-section-label">General</label>
                <div class="menu-row" onclick="toggleClockSound()"><span>üïë Sonido Reloj</span><div id="toggleSound" class="switch-toggle"></div></div>
                <div class="menu-row" onclick="toggleDarkMode()"><span>üåó Modo Oscuro</span><div id="toggleDark" class="switch-toggle"></div></div>
            </div>
            <div class="menu-section">
                <label class="menu-section-label">Visual</label>
                <div class="menu-row" onclick="toggleIconStyle()"><span>üî≥ Estilo Casillas</span><div id="toggleIconStyle" class="switch-toggle"></div></div>
                <div class="menu-row">
                    <span>üìè L√≠nea Semanal</span>
                    <div class="color-dot-container" style="width:24px; height:24px; border:none; box-shadow:0 0 0 1px var(--border-color);">
                        <input type="color" id="dividerColorInput" class="color-dot-input" onchange="updateDividerColor(this.value)">
                    </div>
                </div>
            </div>
            <div class="menu-section">
                <label class="menu-section-label">Gesti√≥n</label>
                <div class="menu-row" onclick="openCategoryManager('categories')"><span>Categor√≠as</span><span>‚Ä∫</span></div>
                <div class="menu-row" onclick="openSubMenu('backup')"><span>Backup</span><span>‚Ä∫</span></div>
            </div>
            <div class="danger-zone"><button onclick="resetData()" class="delete-btn" style="color:var(--danger); text-align:left; width:100%; padding:14px 4px; font-weight:bold;">üóëÔ∏è Eliminar todo</button></div>
        </div>
    </div>

    <div id="genericModal" onclick="closeGenericModal()" class="hidden"><div id="gModalContent" onclick="event.stopPropagation()" class="modal-card"><button onclick="closeGenericModal()" class="absolute" style="top:16px; right:16px; color:var(--text-muted);">‚úï</button><h3 id="gModalTitle" class="font-bold text-lg mb-4">T√≠tulo</h3><div id="gModalBody"></div></div></div>
    <div id="confirmModal" onclick="closeConfirm()" class="hidden"><div class="modal-card" onclick="event.stopPropagation()"><h3 class="font-bold text-lg mb-2">¬øEst√°s seguro?</h3><div class="flex gap-2"><button onclick="closeConfirm()" class="secondary-btn">Cancelar</button><button id="btnConfirmAction" class="primary-btn" style="background-color:var(--danger);">Confirmar</button></div></div></div>
    
    <div id="noteModal" onclick="closeNoteModal()" class="hidden">
        <div onclick="event.stopPropagation()" class="modal-card">
            <h3 class="font-bold text-lg mb-2">Nota</h3>
            <p id="noteModalLabel" class="text-xs text-muted mb-4 uppercase tracking-widest">...</p>
            <textarea id="noteInput" class="clean-input" placeholder="Ej: 3 min de plancha..." style="min-height: 80px; font-size:1rem;"></textarea>
            <div class="flex gap-2">
                <button onclick="saveNote(true)" class="secondary-btn" style="color:var(--danger)">Borrar</button>
                <button onclick="saveNote(false)" class="primary-btn">Guardar</button>
            </div>
        </div>
    </div>

    <div id="customTooltip"></div>

    <div id="newHabitModal" onclick="window.toggleNewHabit(false)" class="hidden">
        <div onclick="event.stopPropagation()" class="modern-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo H√°bito</h3>
                <p class="modal-subtitle">Define tu pr√≥ximo objetivo diario</p>
            </div>
            <div class="input-group">
                <input type="text" id="habitNameInput" placeholder="Ej: Leer 15 minutos..." class="modern-input" autocomplete="off">
            </div>
            <div class="input-group">
                <div class="input-label">
                    <span>Categor√≠a</span>
                    <button onclick="toggleCatCreator(true)" id="btnNewCat" class="mini-btn">+ NUEVA</button>
                </div>
                <div id="categoryChips" class="chips-scroll-area"></div>
                <div id="catCreator" class="creator-box hidden">
                    <div class="color-picker-wrapper" style="width:42px; height:42px; border-width:0;">
                        <input type="color" id="newCatColor" value="#3b82f6">
                    </div>
                    <input id="newCatName" type="text" class="modern-input" style="padding: 10px; border:none; background:transparent;" placeholder="Nombre categor√≠a...">
                    <button onclick="confirmNewCategory()" class="creator-btn-ok">OK</button>
                    <button onclick="toggleCatCreator(false)" style="padding:10px; opacity:0.5;">‚úï</button>
                </div>
            </div>
            <div id="subcatSection" class="input-group hidden">
                <div class="input-label">
                    <span>Subcategor√≠a (Opcional)</span>
                    <button onclick="toggleSubcatCreator(true)" id="btnNewSub" class="mini-btn">+ NUEVA</button>
                </div>
                <div id="subcatChips" class="chips-scroll-area"></div>
                <div id="subcatCreator" class="creator-box hidden">
                    <input id="newSubName" type="text" class="modern-input" style="padding: 10px; border:none; background:transparent;" placeholder="Nombre subcategor√≠a...">
                    <button onclick="confirmNewSubcat()" class="creator-btn-ok">OK</button>
                    <button onclick="toggleSubcatCreator(false)" style="padding:10px; opacity:0.5;">‚úï</button>
                </div>
            </div>
            <button onclick="createHabit()" class="primary-btn" style="margin-top: 8px; font-size: 1rem; padding: 16px;">Crear H√°bito</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        const DEFAULT_CATEGORIES = [{ id: 'gen', name: 'General', color: '#9ca3af', subcategories: [] }];
        let state = { habits: [], categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)), settings: { darkMode: true, collapsedCats: {}, collapsedSubCats: {}, clockSound: false, dailyNote: "", iconStyle: 'minimal', dividerColor: null }, viewDate: new Date() };
        let selectedCategory = null; let selectedSubcat = ""; let confirmCallback = null; let clockInterval = null; let draggedHabitId = null;
        let selectionAnchor = null; 
        let currentManageCatId = null; 
        let tickTockState = false; 

        // ICONS
        const ICON_PENCIL = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`;
        const ICON_TRASH = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;

        function init() {
            try {
                let loaded = JSON.parse(localStorage.getItem('habitTrackerV5'));
                if(!loaded) loaded = JSON.parse(localStorage.getItem('habitTrackerV6_3')) || JSON.parse(localStorage.getItem('habitTrackerV6_1'));
                if (loaded) {
                    state = loaded; 
                    state.viewDate = new Date(); 
                    if(state.categories) state.categories.forEach(c => { if(!c.subcategories) c.subcategories = []; });
                    if(!state.settings.collapsedSubCats) state.settings.collapsedSubCats = {};
                    if(!state.settings.iconStyle) state.settings.iconStyle = 'minimal';
                    // Asegurar objetos base
                    state.habits.forEach(h => { 
                        if (!h.notes) h.notes = {}; 
                        if (h.description === undefined) h.description = "";
                    });
                }
            } catch (e) {}
            applyTheme(); updateSwitches(); renderCalendar(); renderQuote();
            if(state.settings.dividerColor) document.documentElement.style.setProperty('--divider-strong', state.settings.dividerColor);
            if(state.settings.clockSound) playClockAudio(true);
            window.addEventListener('resize', syncHeaderWidth);
            document.getElementById('btnConfirmAction').onclick = () => { if(confirmCallback) confirmCallback(); closeConfirm(); };
        }

        function saveData() { localStorage.setItem('habitTrackerV5', JSON.stringify(state)); }
        function applyTheme() { if (state.settings.darkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }
        function updateSwitches() { 
            const d = document.getElementById('toggleDark'), s = document.getElementById('toggleSound'), i = document.getElementById('toggleIconStyle'); 
            if(state.settings.darkMode) d.classList.add('active'); else d.classList.remove('active'); 
            if(state.settings.clockSound) s.classList.add('active'); else s.classList.remove('active'); 
            if(state.settings.iconStyle === 'solid') i.classList.add('active'); else i.classList.remove('active');
            const divInput = document.getElementById('dividerColorInput');
            if(state.settings.dividerColor) divInput.value = state.settings.dividerColor;
        }
        function toggleClockSound() { state.settings.clockSound = !state.settings.clockSound; saveData(); updateSwitches(); playClockAudio(state.settings.clockSound); showToast('Ajuste guardado'); }
        function toggleIconStyle() { state.settings.iconStyle = (state.settings.iconStyle === 'solid') ? 'minimal' : 'solid'; saveData(); updateSwitches(); renderCalendar(); showToast('Estilo cambiado'); }
        function updateDividerColor(val) {
             state.settings.dividerColor = val; 
             document.documentElement.style.setProperty('--divider-strong', val);
             saveData(); 
        }

        function playAnalogTick() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                const freq = tickTockState ? 2000 : 1500; tickTockState = !tickTockState;
                osc.frequency.setValueAtTime(freq, ctx.currentTime);
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.0, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.005);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05);
                osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.06);
            } catch (e) {}
        }

        function playClockAudio(play) { 
            if(clockInterval) clearInterval(clockInterval); 
            clockInterval = null;
            if(play) { 
                playAnalogTick(); 
                clockInterval = setInterval(()=> playAnalogTick(), 1000); 
            } 
        }

        /* --- DRAG DROP --- */
        function handleDragStart(e, id) { draggedHabitId = id; e.dataTransfer.effectAllowed='move'; e.target.classList.add('dragging'); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.subcategory-row').forEach(el => el.classList.remove('drag-over')); }
        function allowDrop(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function dropOnSubcat(e, catId, subName) { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); const h = state.habits.find(x => x.id == draggedHabitId); if(h) { const tCat = state.categories.find(c => c.id == catId); if(tCat && h.category.id != catId) h.category = tCat; h.subcategory = subName; saveData(); renderCalendar(); showToast('H√°bito movido'); } }
        function dropOnHabit(e, targetId) { e.preventDefault(); const tH = state.habits.find(h=>h.id==targetId), dH = state.habits.find(h=>h.id==draggedHabitId); if(tH && dH && targetId!=draggedHabitId) { if(dH.category.id!=tH.category.id) dH.category=tH.category; dH.subcategory=tH.subcategory; saveData(); renderCalendar(); } }

        /* --- RENDER --- */
        function renderCalendar() {
            const container = document.getElementById('habitsContainer');
            const headerContainer = document.getElementById('calendarHeader');
            container.innerHTML = ''; headerContainer.innerHTML = '';
            
            const dateStr = state.viewDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('currentMonthDisplay').innerText = dateStr;
            const year = state.viewDate.getFullYear(), month = state.viewDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const n = new Date(); const todayISO = `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
            const isSolid = state.settings.iconStyle === 'solid';

            let headerHTML = `<div class="row-structure"><div class="sticky-col-left grid-header-cell">H√°bito</div><div class="days-container">`;
            for (let i = 1; i <= daysInMonth; i++) {
                const d = new Date(year, month, i);
                const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const isWeekEnd = (i % 7 === 0);
                const sep = isWeekEnd ? 'week-separator' : '';
                headerHTML += `<div class="day-header ${iso===todayISO?'today':''} ${sep}"><span>${d.toLocaleDateString('es-ES',{weekday:'narrow'})}</span><span>${i}</span></div>`;
            }
            headerHTML += `</div><div class="sticky-col-right grid-header-cell">%</div></div>`;
            headerContainer.innerHTML = headerHTML;

            const activeHabits = state.habits.filter(h => !h.archived);
            if (activeHabits.length === 0) { container.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-muted);">No hay h√°bitos.</div>`; return; }

            const grid = document.createElement('div'); grid.className = 'flex flex-col min-w-max';
            
            // Funci√≥n auxiliar para limpiar textos (previene errores en HTML)
            const cleanText = (txt) => {
                if(!txt) return "";
                return txt.replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, "<br>");
            };

            state.categories.forEach(cat => {
                const catHabits = activeHabits.filter(h => h.category.id == cat.id);
                if (catHabits.length === 0 && (!cat.subcategories || cat.subcategories.length === 0)) return;

                let dotColor = null;
                if (catHabits.length > 0) {
                    const allDone = catHabits.every(h => { const s = h.history[todayISO]; return s === 'done' || s === 'skip' || s === 'fail'; });
                    dotColor = allDone ? 'var(--success)' : 'var(--danger)';
                }
                const isCollapsed = state.settings.collapsedCats[cat.id];
                const catHead = document.createElement('div'); catHead.className = 'category-group-header';
                let dotHTML = dotColor ? `<div class="cat-status-dot" style="background:${dotColor}; box-shadow:0 0 4px ${dotColor};"></div>` : '';
                
                catHead.innerHTML = `<div class="cat-header-sticky"><div class="cat-info" onclick="toggleCategory('${cat.id}')"><span style="color:${cat.color}; font-size:0.7rem;">${isCollapsed?'‚ñ∫':'‚ñº'}</span><span>${cat.name}</span>${dotHTML}</div><button onclick="openCategoryMenu('${cat.id}')" class="menu-btn-shared">‚ãÆ</button></div><div class="cat-header-fill"></div>`;
                grid.appendChild(catHead);

                if (isCollapsed) return;

                const grouped = {};
                catHabits.forEach(h => { const s = h.subcategory ? h.subcategory.trim() : ""; if(!grouped[s]) grouped[s] = []; grouped[s].push(h); });
                const definedSubs = cat.subcategories || [];
                const allSubKeys = new Set([...Object.keys(grouped), ...definedSubs]);
                const sortedKeys = Array.from(allSubKeys).sort((a,b) => { if(a==="") return -1; if(b==="") return 1; return a.localeCompare(b); });

                sortedKeys.forEach(subKey => {
                    if(subKey !== "") {
                        let subDotColor = null;
                        const subHabits = grouped[subKey] || [];
                        if (subHabits.length > 0) {
                            const subAllDone = subHabits.every(h => { const s = h.history[todayISO]; return s === 'done' || s === 'skip' || s === 'fail'; });
                            subDotColor = subAllDone ? 'var(--success)' : 'var(--danger)';
                        }
                        const subDotHTML = subDotColor ? `<div class="cat-status-dot" style="background:${subDotColor}; margin-right:auto; margin-left:8px;"></div>` : '';

                        const subKeyId = `${cat.id}_${subKey}`;
                        const isSubCollapsed = state.settings.collapsedSubCats[subKeyId];
                        const subArrow = isSubCollapsed ? '‚ñ∫' : '‚ñº';
                        const subRow = document.createElement('div'); subRow.className = 'subcategory-row';
                        subRow.ondragover = (e) => allowDrop(e); subRow.ondragleave = (e) => handleDragLeave(e); subRow.ondrop = (e) => dropOnSubcat(e, cat.id, subKey);
                        
                        subRow.innerHTML = `<div class="subcat-label" style="border-left:4px solid ${cat.color};"><div class="subcat-click-area" onclick="toggleSubCat('${cat.id}', '${subKey}')"><span style="font-size:0.6rem;">${subArrow}</span><span>${subKey}</span>${subDotHTML}</div><button class="menu-btn-shared" onclick="openSubcatMenu('${cat.id}', '${subKey}')">‚ãÆ</button></div><div class="subcat-line"></div>`;
                        grid.appendChild(subRow);
                        if(isSubCollapsed) return;
                    }

                    (grouped[subKey] || []).forEach(h => {
                        const row = document.createElement('div'); row.className = 'habit-row row-structure';
                        row.draggable = true; row.ondragstart = (e) => handleDragStart(e, h.id); row.ondragend = (e) => handleDragEnd(e); row.ondragover = (e) => e.preventDefault(); row.ondrop = (e) => dropOnHabit(e, h.id);

                        let streak = 0; const dNow = new Date();
                        for(let k=0;k<365;k++){ const iso = dNow.toISOString().split('T')[0]; if(h.history[iso]==='done') streak++; else if(k>0) break; dNow.setDate(dNow.getDate()-1); }

                        // ARREGLO PARA TOOLTIP EN NOMBRE
                        let cells = `<div class="sticky-col-left habit-name-cell" onclick="openHabitOptions(${h.id})" onmousemove="moveTooltip(event)" onmouseenter="showTooltip(event, '${cleanText(h.description)}', 'Informaci√≥n')" onmouseleave="hideTooltip()"><div class="flex items-center gap-2 overflow-hidden" style="flex:1"><div class="drag-handle">::</div><div style="width:6px; height:6px; border-radius:50%; background:${cat.color}"></div><span class="text-sm font-medium truncate">${h.name}</span></div>${(h.showStreak!==false && streak>0) ? `<div class="streak-badge active">üî• ${streak}</div>` : ''}</div><div class="days-container">`;

                        let checks=0;
                        for(let i=1; i<=daysInMonth; i++) {
                            const loopIso = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                            const isToday = loopIso === todayISO;
                            const stat = h.history[loopIso];
                            
                            const note = (h.notes && h.notes[loopIso]) ? h.notes[loopIso] : '';
                            const indicator = note ? `<div class="note-indicator"></div>` : '';

                            if(stat==='done' || stat==='skip') checks++;
                            
                            const isWeekEnd = (i % 7 === 0);
                            let cls = 'cell-btn ' + (isWeekEnd ? 'week-separator ' : '') + (isToday?'today-border':'');
                            let style = '', txt = '';

                            if(stat==='done') { 
                                if(isSolid) { style=`background-color:${cat.color}; color:#fff;`; txt='‚úì'; }
                                else { style=`color:${cat.color}; font-weight:bold;`; txt='‚úì'; }
                            }
                            else if(stat==='fail') { 
                                if(isSolid) { style='background-color:var(--danger); color:#fff;'; txt='‚úó'; }
                                else { style='color:var(--danger);'; txt='‚úó'; }
                            }
                            else if(stat==='skip') { 
                                cls+=' state-skip'; txt='‚àí'; 
                                if(isSolid) { style="background-color:#333; color:#fff;"; }
                            } 
                            
                            // ARREGLO PARA TOOLTIP EN CASILLAS
                            cells += `<div 
                                onclick="toggleDay(${h.id}, '${loopIso}', event)"
                                oncontextmenu="openNoteModal(${h.id}, '${loopIso}', event)"
                                onmousemove="moveTooltip(event)"
                                onmouseenter="showTooltip(event, '${cleanText(note)}', '${cleanText(h.name)}')"
                                onmouseleave="hideTooltip()"
                                class="${cls}" style="${style}">${txt} ${indicator}</div>`;
                        }
                        cells += `</div><div class="sticky-col-right grid-header-cell">${Math.round((checks/daysInMonth)*100)}%</div>`;
                        row.innerHTML = cells;
                        grid.appendChild(row);
                    });
                });
            });
            container.appendChild(grid);
            container.onscroll = () => { headerContainer.scrollLeft = container.scrollLeft; };
            setTimeout(syncHeaderWidth, 0);
        }

        function syncHeaderWidth() {
            const container = document.getElementById('habitsContainer');
            const header = document.getElementById('calendarHeader');
            if(!container || !header) return;
            const scrollbarWidth = container.offsetWidth - container.clientWidth;
            header.style.paddingRight = `${scrollbarWidth}px`;
        }

        /* --- LOGIC --- */
        function toggleCategory(id) { state.settings.collapsedCats[id] = !state.settings.collapsedCats[id]; saveData(); renderCalendar(); }
        function toggleSubCat(catId, subName) { const key = `${catId}_${subName}`; state.settings.collapsedSubCats[key] = !state.settings.collapsedSubCats[key]; saveData(); renderCalendar(); }
        
        function toggleDay(id, iso, event) {
            const h = state.habits.find(x => x.id === id); if(!h) return;
            const getNext = (s) => { if(!s) return 'done'; if(s==='done') return 'fail'; if(s==='fail') return 'skip'; return null; };

            if(event && event.shiftKey && selectionAnchor && selectionAnchor.id === id) {
                h.history = { ...selectionAnchor.snapshot }; 
                if(selectionAnchor.lastTarget === iso) { selectionAnchor.activeState = getNext(selectionAnchor.activeState); } else { selectionAnchor.lastTarget = iso; }
                const stateToApply = selectionAnchor.activeState;
                const startIso = (selectionAnchor.date < iso) ? selectionAnchor.date : iso;
                const endIso = (selectionAnchor.date < iso) ? iso : selectionAnchor.date;
                let current = new Date(startIso + "T12:00:00"); const end = new Date(endIso + "T12:00:00");
                let safety = 0;
                while(current <= end && safety < 365) {
                    const loopIso = `${current.getFullYear()}-${String(current.getMonth()+1).padStart(2,'0')}-${String(current.getDate()).padStart(2,'0')}`;
                    if(stateToApply) h.history[loopIso] = stateToApply; else delete h.history[loopIso];
                    current.setDate(current.getDate() + 1); safety++;
                }
                if(stateToApply === 'done') { playSound(); triggerConfetti(); }
            } else {
                const curr = h.history[iso]; const nextState = getNext(curr);
                if(nextState) h.history[iso] = nextState; else delete h.history[iso];
                if(nextState === 'done') { playSound(); triggerConfetti(); }
                selectionAnchor = { id: id, date: iso, activeState: nextState, lastTarget: iso, snapshot: { ...h.history } };
            }
            saveData(); renderCalendar();
        }

        function changeMonth(d) { state.viewDate.setMonth(state.viewDate.getMonth()+d); renderCalendar(); }

        /* --- CATEGORY MANAGER --- */
        function openCategoryManager(initialTab = 'categories') {
            window.toggleMenu(false);
            const html = `
                <div class="tabs-header">
                    <button onclick="renderCatTab()" id="tabBtnCats" class="tab-btn">Categor√≠as</button>
                    <button onclick="renderSubTab()" id="tabBtnSubs" class="tab-btn">Subcategor√≠as</button>
                </div>
                <div id="managerContent"></div>
            `;
            openGenericModal('Gesti√≥n', html);
            if(initialTab === 'subcategories') renderSubTab(); else renderCatTab();
        }

        function renderCatTab() {
            document.getElementById('tabBtnCats').classList.add('active');
            document.getElementById('tabBtnSubs').classList.remove('active');
            let html = '<div style="display:flex; flex-direction:column; gap:8px;">';
            state.categories.forEach((c, i) => { 
                html += `<div class="cat-list-item">
                    <div class="flex items-center">
                        <div class="color-dot-container" title="Cambiar color">
                             <input type="color" class="color-dot-input" value="${c.color}" onchange="updateCatColor('${c.id}', this.value)">
                        </div>
                        <span class="font-medium text-sm">${c.name}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openRenameCategory('${c.id}')" class="action-icon-btn" title="Renombrar">${ICON_PENCIL}</button>
                        <button onclick="removeCategory(${i})" class="action-icon-btn danger" title="Eliminar">${ICON_TRASH}</button>
                    </div>
                </div>`; 
            });
            html += `</div><div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);"><label class="text-xs font-bold uppercase tracking-widest" style="color: var(--text-muted); display: block; margin-bottom: 8px;">Nueva Categor√≠a</label><div class="flex gap-2 items-center relative"><div class="color-picker-wrapper"><input type="color" id="newCatColorInput" value="#10b981"></div><input id="newCatInput" placeholder="Ej: Deportes..." style="flex:1; background: var(--bg-surface); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); outline: none;"><button onclick="addCategory()" class="primary-btn" style="padding: 0 12px; height: 38px;">+</button></div></div>`;
            document.getElementById('managerContent').innerHTML = html;
        }

        function updateCatColor(id, newColor) {
            const cat = state.categories.find(c => c.id == id);
            if(cat) {
                cat.color = newColor;
                state.habits.forEach(h => { if(h.category.id == id) { h.category.color = newColor; } });
                saveData(); renderCalendar(); showToast('Color actualizado');
            }
        }

        function openRenameCategory(id) {
            const cat = state.categories.find(c => c.id == id);
            if(!cat) return;
            const html = `
                <div class="input-group">
                    <label class="input-label">Nuevo Nombre</label>
                    <input id="editCatNameInput" value="${cat.name}" class="modern-input">
                </div>
                <button onclick="saveCategoryName('${id}')" class="primary-btn" style="margin-top:24px;">Guardar</button>
            `;
            openGenericModal('Renombrar: ' + cat.name, html);
            setTimeout(() => document.getElementById('editCatNameInput').focus(), 100);
        }

        function saveCategoryName(id) {
            const newName = document.getElementById('editCatNameInput').value.trim();
            if(!newName) return showToast('Nombre inv√°lido');
            const cat = state.categories.find(c => c.id == id);
            if(cat) {
                cat.name = newName;
                state.habits.forEach(h => { if(h.category.id == id) { h.category.name = newName; } });
                saveData(); renderCalendar(); openCategoryManager('categories'); showToast('Nombre actualizado');
            }
        }

        function renderSubTab() {
            document.getElementById('tabBtnCats').classList.remove('active');
            document.getElementById('tabBtnSubs').classList.add('active');
            if(!currentManageCatId && state.categories.length > 0) currentManageCatId = state.categories[0].id;
            let catOptions = '';
            state.categories.forEach(c => { catOptions += `<option value="${c.id}" ${c.id == currentManageCatId ? 'selected' : ''}>${c.name}</option>`; });
            const html = `
                <label class="text-xs font-bold uppercase tracking-widest text-muted mb-2 block">Categor√≠a Padre</label>
                <select id="parentCatSelect" class="cat-select-dropdown" onchange="updateSubcatView(this.value)">${catOptions}</select>
                <div id="subcatListArea"></div>
            `;
            document.getElementById('managerContent').innerHTML = html;
            updateSubcatView(currentManageCatId);
        }

        function updateSubcatView(catId) {
            currentManageCatId = catId;
            const cat = state.categories.find(c => c.id == catId);
            const listArea = document.getElementById('subcatListArea');
            if(!cat) return;

            let html = '<div style="display:flex; flex-direction:column; gap:8px; max-height:200px; overflow-y:auto; margin-bottom:16px;">';
            if(!cat.subcategories || cat.subcategories.length === 0) {
                html += '<p class="text-sm text-muted">No hay subcategor√≠as.</p>';
            } else {
                cat.subcategories.forEach(sub => {
                    html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:var(--bg-surface); border-radius:8px;">
                        <span class="text-sm">${sub}</span>
                        <div class="flex gap-2">
                            <button onclick="openRenameSubcat('${cat.id}', '${sub}')" class="action-icon-btn" title="Editar">${ICON_PENCIL}</button>
                            <button onclick="deleteSubGlobal('${cat.id}', '${sub}')" class="action-icon-btn danger" title="Eliminar">${ICON_TRASH}</button>
                        </div>
                    </div>`;
                });
            }
            html += '</div>';
            html += `<div style="border-top:1px solid var(--border-color); padding-top:12px;"><div style="display:flex; gap:8px;"><input id="newSubInputGlobal" class="clean-input" placeholder="Nueva subcategor√≠a..." style="margin:0; font-size:0.9rem;" onkeyup="if(event.key==='Enter') addSubcatGlobal()"><button onclick="addSubcatGlobal()" class="primary-btn" style="width:auto; padding:0 16px;">+</button></div></div>`;
            listArea.innerHTML = html;
            setTimeout(()=> { try { document.getElementById('newSubInputGlobal').focus(); } catch(e){} }, 100);
        }

        function openRenameSubcat(catId, oldName) {
             const html = `
                <div class="input-group">
                    <label class="input-label">Nuevo Nombre</label>
                    <input id="editSubName" value="${oldName}" class="modern-input">
                </div>
                <button onclick="saveSubcatEdit('${catId}', '${oldName}')" class="primary-btn" style="margin-top:24px;">Guardar</button>
            `;
            openGenericModal('Editar Subcategor√≠a', html);
            setTimeout(() => document.getElementById('editSubName').focus(), 100);
        }

        function saveSubcatEdit(catId, oldName) {
            const newName = document.getElementById('editSubName').value.trim();
            if(!newName) return showToast('Nombre vac√≠o');
            
            const cat = state.categories.find(c => c.id == catId);
            if(cat) {
                const idx = cat.subcategories.indexOf(oldName);
                if(idx !== -1) cat.subcategories[idx] = newName;
                state.habits.forEach(h => {
                    if(h.category.id == catId && h.subcategory === oldName) { h.subcategory = newName; }
                });
                saveData(); renderCalendar(); openCategoryManager('subcategories'); showToast('Subcategor√≠a renombrada');
            }
        }

        function addSubcatGlobal() {
            const input = document.getElementById('newSubInputGlobal');
            const n = input.value.trim();
            if(n && currentManageCatId) {
                const cat = state.categories.find(c => c.id == currentManageCatId);
                if(cat) {
                    if(!cat.subcategories) cat.subcategories = [];
                    if(!cat.subcategories.includes(n)) { 
                        cat.subcategories.push(n); saveData(); showToast('Subcategor√≠a a√±adida'); renderCalendar(); 
                    } else { showToast('Ya existe'); }
                    updateSubcatView(currentManageCatId);
                }
            }
        }

        function deleteSubGlobal(catId, subName) {
            const cat = state.categories.find(c => c.id == catId);
            if(cat) {
                showConfirm('¬øEliminar subcategor√≠a?', () => {
                    cat.subcategories = cat.subcategories.filter(s => s !== subName);
                    state.habits.forEach(h => { if(h.category.id == catId && h.subcategory === subName) { h.subcategory = ""; } });
                    saveData(); updateSubcatView(catId); renderCalendar(); showToast('Subcategor√≠a eliminada');
                });
            }
        }

        function addCategory() { const i = document.getElementById('newCatInput'), cIn = document.getElementById('newCatColorInput'); if(i.value.trim()){ state.categories.push({id:Date.now(), name:i.value.trim(), color: cIn.value, subcategories:[]}); saveData(); renderCatTab(); renderCalendar(); showToast('Categor√≠a creada'); } }
        function removeCategory(i) { 
            const cat = state.categories[i]; 
            showConfirm('¬øEliminar categor√≠a? Se borrar√°n sus h√°bitos.', () => {
                 state.categories.splice(i,1); if(cat) state.habits = state.habits.filter(h => h.category.id != cat.id); 
                 saveData(); renderCatTab(); renderCalendar(); showToast('Categor√≠a eliminada'); 
            });
        }
        
        function openSubcatMenu(catId, subName) { openRenameSubcat(catId, subName); }
        function openCategoryMenu(id) { currentManageCatId = id; openCategoryManager('subcategories'); }

        /* --- OTHERS --- */
        window.toggleMenu = function(show) { const o = document.getElementById('menuOverlay'), c = document.getElementById('menuContent'); if(show){ o.classList.remove('hidden'); setTimeout(() => { o.classList.remove('opacity-0'); c.classList.add('open'); }, 10); } else { o.classList.add('opacity-0'); c.classList.remove('open'); setTimeout(() => o.classList.add('hidden'), 300); } }
        function openSubMenu(type) {
            window.toggleMenu(false);
            if (type === 'backup') { openGenericModal('Backup', `<button onclick="downloadData()" class="primary-btn" style="margin-bottom:12px;">Descargar Backup</button><input type="file" onchange="uploadData(this)" style="display:block; width:100%; font-size:0.8rem; color:var(--text-muted);">`); }
        }
        
        window.toggleNewHabit = function(show) { 
            const el = document.getElementById('newHabitModal'); 
            if(show) { 
                if(state.categories.length > 0) { selectedCategory = state.categories[0]; } else { selectedCategory = null; }
                selectedSubcat = ""; 
                document.getElementById('habitNameInput').value = ""; 
                toggleCatCreator(false); toggleSubcatCreator(false);
                if(!selectedCategory) { toggleCatCreator(true); } else { renderCategoryChips(); }
                el.classList.remove('hidden'); setTimeout(()=>el.classList.add('active'), 10); 
                setTimeout(() => document.getElementById('habitNameInput').focus(), 100); 
            } else { 
                el.classList.remove('active'); setTimeout(()=>el.classList.add('hidden'), 200); 
            } 
        }

        function renderCategoryChips() { 
            const c = document.getElementById('categoryChips'); c.innerHTML = ''; 
            if(state.categories.length === 0) return;
            state.categories.forEach(cat => { 
                const isSelected = selectedCategory && selectedCategory.id === cat.id;
                const d = document.createElement('div'); d.className = `chip-modern ${isSelected ? 'active' : ''}`; 
                let dotHtml = isSelected ? '' : `<div class="chip-dot" style="background-color: ${cat.color}"></div>`;
                d.innerHTML = `${dotHtml}${cat.name}`; 
                d.onclick = () => { selectedCategory = cat; selectedSubcat = ""; toggleCatCreator(false); renderCategoryChips(); }; 
                c.appendChild(d); 
            }); 
            renderSubcatChips(); 
        }

        function renderSubcatChips() { 
            const section = document.getElementById('subcatSection');
            const container = document.getElementById('subcatChips'); container.innerHTML = ''; 
            if(!selectedCategory) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            if(selectedCategory.subcategories && selectedCategory.subcategories.length > 0) { 
                selectedCategory.subcategories.forEach(sub => { 
                    const isSelected = selectedSubcat === sub;
                    const d = document.createElement('div'); d.className = `chip-modern ${isSelected ? 'active' : ''}`; d.innerText = sub; 
                    d.onclick = () => { selectedSubcat = (selectedSubcat === sub) ? "" : sub; toggleSubcatCreator(false); renderSubcatChips(); }; 
                    container.appendChild(d); 
                }); 
            } else { container.innerHTML = '<span class="text-xs text-muted" style="padding:8px 0;">Sin subcategor√≠as.</span>'; } 
        }

        function toggleCatCreator(show) {
            const chips = document.getElementById('categoryChips'); const creator = document.getElementById('catCreator'); const btn = document.getElementById('btnNewCat');
            if(show) { chips.classList.add('hidden'); btn.classList.add('hidden'); creator.classList.remove('hidden'); creator.classList.add('flex'); document.getElementById('newCatName').value = ""; document.getElementById('newCatName').focus(); } 
            else { chips.classList.remove('hidden'); btn.classList.remove('hidden'); creator.classList.add('hidden'); creator.classList.remove('flex'); }
        }
        function confirmNewCategory() {
            const nameInput = document.getElementById('newCatName'); const colorInput = document.getElementById('newCatColor'); const name = nameInput.value.trim();
            if(name) {
                const newCat = { id: Date.now(), name: name, color: colorInput.value, subcategories: [] };
                state.categories.push(newCat); selectedCategory = newCat; selectedSubcat = "";
                saveData(); toggleCatCreator(false); renderCategoryChips(); showToast('Categor√≠a creada');
            } else { showToast('Escribe un nombre'); nameInput.focus(); }
        }

        function toggleSubcatCreator(show) {
            const chips = document.getElementById('subcatChips'); const creator = document.getElementById('subcatCreator'); const btn = document.getElementById('btnNewSub');
            if(show) { chips.classList.add('hidden'); btn.classList.add('hidden'); creator.classList.remove('hidden'); creator.classList.add('flex'); document.getElementById('newSubName').value = ""; document.getElementById('newSubName').focus(); } 
            else { chips.classList.remove('hidden'); btn.classList.remove('hidden'); creator.classList.add('hidden'); creator.classList.remove('flex'); }
        }
        function confirmNewSubcat() {
            const nameInput = document.getElementById('newSubName'); const name = nameInput.value.trim();
            if(name && selectedCategory) {
                if(!selectedCategory.subcategories) selectedCategory.subcategories = [];
                if(!selectedCategory.subcategories.includes(name)) { selectedCategory.subcategories.push(name); saveData(); showToast('Subcategor√≠a creada'); }
                selectedSubcat = name; toggleSubcatCreator(false); renderSubcatChips();
            } else { showToast('Escribe un nombre'); }
        }

        function createHabit() { 
            const n = document.getElementById('habitNameInput').value.trim(); 
            if(!n) return showToast('Falta el nombre'); if(!selectedCategory) return showToast('Elige categor√≠a'); 
            state.habits.push({ id: Date.now(), name: n, category: selectedCategory, subcategory: selectedSubcat, history: {}, notes: {}, description: "", archived: false, created: new Date().toISOString() }); 
            saveData(); window.toggleNewHabit(false); renderCalendar(); showToast('H√°bito creado'); 
        }

        function openGenericModal(t, c) { document.getElementById('gModalTitle').innerText=t; document.getElementById('gModalBody').innerHTML=c; const el=document.getElementById('genericModal'); el.classList.remove('hidden'); setTimeout(()=>el.classList.add('active'),10); }
        function closeGenericModal() { const el=document.getElementById('genericModal'); el.classList.remove('active'); setTimeout(()=>el.classList.add('hidden'),200); }
        function showConfirm(m, cb) { document.getElementById('confirmModal').querySelector('h3').innerText=m; confirmCallback=cb; const el=document.getElementById('confirmModal'); el.classList.remove('hidden'); setTimeout(()=>el.classList.add('active'),10); }
        function closeConfirm() { const el=document.getElementById('confirmModal'); el.classList.remove('active'); setTimeout(()=>el.classList.add('hidden'),200); confirmCallback=null; }
        function showToast(m) { const t=document.createElement('div'); t.className='toast'; t.innerText=m; document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(),3000); }
        function editQuote() { openGenericModal('Frase', `<textarea id="qIn" class="clean-input">${state.settings.dailyNote||""}</textarea><button onclick="saveQ()" class="primary-btn">Guardar</button>`); }
        function saveQ() { state.settings.dailyNote = document.getElementById('qIn').value; saveData(); renderQuote(); closeGenericModal(); showToast('Frase guardada'); }
        function renderQuote() { document.getElementById('quoteDisplay').innerText = state.settings.dailyNote || "Haz clic para escribir una frase..."; }
        
        /* --- GESTI√ìN H√ÅBITO --- */
        function openHabitOptions(id) { 
            const h = state.habits.find(x => x.id === id); 
            const html = `
                <div class="input-group" style="margin-bottom:16px;">
                    <label class="input-label" style="margin-bottom:4px;">Nombre</label>
                    <input id="renameInput_${id}" type="text" value="${h.name}" class="modern-input">
                </div>
                <div class="input-group" style="margin-bottom:16px;">
                    <label class="input-label" style="margin-bottom:4px;">Descripci√≥n / Beneficios</label>
                    <textarea id="descInput_${id}" class="modern-input" style="min-height:80px; font-size:0.9rem;">${h.description || ""}</textarea>
                </div>
                <button onclick="saveHabitEdits(${id})" class="primary-btn" style="margin-bottom:12px;">Guardar Cambios</button>
                <div style="height:1px; background:var(--border-color); margin:8px 0;"></div>
                <button onclick="deleteHabit(${id})" class="option-btn" style="color:var(--danger)">üóëÔ∏è Eliminar H√°bito</button>`;
            openGenericModal('Editar H√°bito', html); 
        }
        function saveHabitEdits(id) {
            const newName = document.getElementById(`renameInput_${id}`).value.trim();
            const newDesc = document.getElementById(`descInput_${id}`).value.trim();
            if(!newName) return showToast('Falta el nombre');
            const h = state.habits.find(x => x.id === id);
            if(h) { 
                h.name = newName; 
                h.description = newDesc;
                saveData(); 
                renderCalendar(); 
                closeGenericModal(); 
                showToast('H√°bito actualizado'); 
            }
        }
        function deleteHabit(id) { closeGenericModal(); state.habits=state.habits.filter(h=>h.id!==id); saveData(); renderCalendar(); showToast('Eliminado'); }
        function resetData() { localStorage.clear(); location.reload(); }
        function toggleDarkMode() { state.settings.darkMode=!state.settings.darkMode; applyTheme(); updateSwitches(); saveData(); showToast('Modo cambiado'); }
        function downloadData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state)); a.download="habit_tracker_backup.json"; a.click(); }
        function uploadData(i) { const r=new FileReader(); r.onload=e=>{ try{state=JSON.parse(e.target.result);saveData();location.reload();}catch(x){showToast('Error archivo');}}; r.readAsText(i.files[0]); }
        function playSound() { try { const c=new(window.AudioContext||window.webkitAudioContext); const o=c.createOscillator();const g=c.createGain(); o.connect(g);g.connect(c.destination); o.frequency.value=800; g.gain.setValueAtTime(0.05,c.currentTime); g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.05); o.start();o.stop(c.currentTime+0.05); } catch(e){} }
        function triggerConfetti() { const c=document.getElementById('confettiCanvas'); const x=c.getContext('2d'); c.width=window.innerWidth; c.height=window.innerHeight; const p=[]; for(let i=0;i<40;i++) p.push({x:Math.random()*c.width, y:-20, vx:(Math.random()-0.5)*5, vy:Math.random()*5+2, c:'#fbbf24', l:100}); function a(){x.clearRect(0,0,c.width,c.height); p.forEach(e=>{if(e.l>0){e.x+=e.vx;e.y+=e.vy;e.l--;x.fillStyle=e.c;x.fillRect(e.x,e.y,6,6);}}); requestAnimationFrame(a);} a(); }

        /* --- NOTAS & TOOLTIP LOGIC --- */
        let activeNoteHabit = null, activeNoteDate = null;
        let tooltipTimer = null;

        function openNoteModal(id, iso, e) {
            e.preventDefault(); 
            activeNoteHabit = id; activeNoteDate = iso;
            const h = state.habits.find(x => x.id === id);
            if(!h.notes) h.notes = {}; 
            
            document.getElementById('noteModalLabel').innerText = iso;
            document.getElementById('noteInput').value = h.notes[iso] || "";
            
            const el = document.getElementById('noteModal');
            el.classList.remove('hidden');
            setTimeout(() => {
                el.classList.add('active'); 
                document.getElementById('noteInput').focus();
            }, 10);
            return false;
        }

        function closeNoteModal() {
            const el = document.getElementById('noteModal');
            el.classList.remove('active'); 
            setTimeout(() => el.classList.add('hidden'), 200);
        }

        function saveNote(isDelete) {
            const val = document.getElementById('noteInput').value.trim();
            const h = state.habits.find(x => x.id === activeNoteHabit);
            if(h) {
                if(!h.notes) h.notes = {};
                if(isDelete || val === "") delete h.notes[activeNoteDate];
                else h.notes[activeNoteDate] = val;
                saveData(); renderCalendar();
            }
            closeNoteModal();
        }

        const tooltip = document.getElementById('customTooltip');
        
        function showTooltip(e, text, title) {
            if(!text || text === "undefined") return;
            
            if(tooltipTimer) clearTimeout(tooltipTimer);
            
            tooltip.innerHTML = `<div style="font-size:0.7rem; opacity:0.7; margin-bottom:4px; text-transform:uppercase; letter-spacing:0.05em;">${title}</div><div style="line-height:1.4;">${text}</div>`;
            
            moveTooltip(e); // Posicionar inmediatamente (aunque invisible)

            // Esperar 800ms antes de mostrar (OPACIDAD 1)
            tooltipTimer = setTimeout(() => {
                tooltip.style.opacity = 1;
            }, 800);
        }

        function hideTooltip() { 
            if(tooltipTimer) clearTimeout(tooltipTimer);
            tooltip.style.opacity = 0; 
        }

        function moveTooltip(e) {
            let x = e.clientX + 15, y = e.clientY + 15;
            // Ajustes para que no se salga de la pantalla
            if(x + 240 > window.innerWidth) x -= 250; 
            if(y + 100 > window.innerHeight) y -= 100;
            
            tooltip.style.left = x + 'px'; 
            tooltip.style.top = y + 'px';
        }

        init();
    </script>
</body>
</html>
